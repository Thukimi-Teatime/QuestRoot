<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuestRoot: Tactical Focus (v0.25.17)</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --primary-color: #38bdf8;
            --main-quest-color: #f97316;
            --section-color: #a855f7;
            --sub-quest-color: #0ea5e9;
            --command-color: #10b981;
            --border-color: #334155;
            --text-color: #f1f5f9;
            --work-done-color: #f59e0b;
            --report-done-color: #10b981;
            --danger-color: #ef4444;
            --blitz-color: #f43f5e;
            --steady-color: #38bdf8;
            --template-color: #ec4899;
            --character-card-bg: #1e293b;
            --commander-color: #a855f7;
            --elder-color: #fbbf24;
            --transfer-ready-color: #ef4444;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.5; }
        .container { max-width: 1800px; margin: 0 auto; display: grid; grid-template-columns: 1fr 450px 280px; gap: 20px; }
        
        header { grid-column: 1 / span 3; text-align: center; padding: 20px; background: var(--panel-bg); border-radius: 12px; border: 1px solid var(--border-color); }

        #system-log {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.85rem;
            line-height: 1.8;
            min-height: calc(0.85rem * 1.8 * 5);
            max-height: calc(0.85rem * 1.8 * 5);
            overflow-y: auto;
            transition: border-color 0.3s;
            position: relative;
        }

        #system-log:empty::before {
            content: 'SYSTEM LOG (STANDBY...)';
            opacity: 0.3;
            font-size: 0.75rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            letter-spacing: 2px;
        }

        #system-log.active {
            border-color: var(--command-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            animation: logFadeIn 0.3s ease-out;
        }

        @keyframes logFadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-time {
            font-size: 0.7rem;
            opacity: 0.5;
            font-family: 'Courier New', monospace;
            min-width: 60px;
        }

        .log-icon {
            font-size: 1rem;
            min-width: 24px;
        }

        .log-text {
            flex: 1;
            font-size: 0.85rem;
        }

        .log-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .badge-priority {
            background: var(--command-color);
            color: white;
        }

        .badge-bonus {
            background: var(--elder-color);
            color: var(--bg-color);
        }

        .btn-clear-log {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            cursor: pointer;
            opacity: 0.5;
            transition: 0.2s;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .btn-clear-log:hover {
            opacity: 1;
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        /* ÈÄ±Ê¨°Ëª¢ËÅ∑ÂõûÊï∞Ë°®Á§∫ */
        .transfer-counter {
            color: var(--primary-color);
            font-size: 0.65rem;
            font-weight: bold;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .transfer-counter.limit-reached {
            color: var(--danger-color);
        }

        .exp-priority-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            cursor: pointer;
            margin-top: 6px;
            width: 100%;
            transition: 0.2s;
        }

        .exp-priority-btn:hover {
            border-color: var(--command-color);
        }

        .exp-priority-btn.active {
            background: var(--command-color);
            color: white;
            border-color: var(--command-color);
            font-weight: bold;
        }

        .level-cap-warning {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid var(--elder-color);
            color: var(--elder-color);
            padding: 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            text-align: center;
            margin-top: 8px;
            font-weight: bold;
        }

        #battle-view { background: var(--panel-bg); color: var(--text-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); position: sticky; top: 20px; height: fit-content; max-height: 90vh; overflow-y: auto; }
        
        #character-panel { background: var(--panel-bg); color: var(--text-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); position: sticky; top: 20px; height: fit-content; max-height: 90vh; overflow-y: auto; }
        
        .character-card { background: var(--character-card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 12px; transition: 0.2s; position: relative; }
        .character-card:hover { border-color: var(--primary-color); }
        .character-card.commander { border-color: var(--commander-color); background: rgba(168, 85, 247, 0.1); }
        .character-card.elder { border-color: var(--elder-color); background: rgba(251, 191, 36, 0.1); }
        .character-card.empty { border-style: dashed; opacity: 0.5; cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 120px; }
        .character-card.empty:hover { opacity: 1; background: rgba(56, 189, 248, 0.1); }
        .character-card.ready-for-assignment { border: 2px solid var(--command-color); }
        .character-card.ready-for-transfer { border: 2px solid var(--transfer-ready-color); }
        
        .character-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .character-name { font-size: 0.85rem; font-weight: bold; color: var(--primary-color); }
        .character-name.transfer-ready { color: var(--transfer-ready-color); }
        .character-job { font-size: 0.7rem; color: var(--text-color); opacity: 0.7; }
        
        .character-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px; }
        .stat-item { display: flex; justify-content: space-between; font-size: 0.7rem; padding: 4px 6px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .stat-label { opacity: 0.7; }
        .stat-value { font-weight: bold; color: var(--primary-color); }
        .stat-value.buffed { color: var(--command-color); }
        .stat-value.debuffed { color: var(--danger-color); }
        
        .stat-bonus {
            font-size: 0.6rem;
            opacity: 0.7;
            margin-left: 2px;
        }
        
        .ready-badge { position: absolute; top: 8px; left: 8px; background: var(--command-color); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; font-weight: bold; }
        .transfer-ready-badge { position: absolute; top: 8px; left: 8px; background: var(--transfer-ready-color); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; font-weight: bold; }
        .training-bonus { font-size: 0.6rem; color: var(--elder-color); margin-top: 4px; font-weight: bold; }
        .btn-assign { background: var(--command-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; margin-top: 8px; font-weight: bold; }
        .btn-assign:hover { opacity: 0.8; }
        .btn-assign:disabled { opacity: 0.3; cursor: not-allowed; background: #475569; }
        
        .btn-transfer { background: var(--transfer-ready-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; margin-top: 8px; font-weight: bold; }
        .btn-transfer:hover { opacity: 0.8; }
        .btn-transfer:disabled { opacity: 0.3; cursor: not-allowed; background: #475569; }
        
        /* Character Equipment Modal Styles */
        .character-equipment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .character-equipment-content {
            background: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: var(--danger-color);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .stats-section, .equipment-section, .buffs-section {
            margin-bottom: 20px;
        }
        
        .stats-section h4, .equipment-section h4, .buffs-section h4 {
            margin: 0 0 12px 0;
            font-size: 0.85rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }
        
        .stats-grid {
            display: grid;
            gap: 8px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .stat-label {
            opacity: 0.8;
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--command-color);
        }
        
        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .equipment-slot {
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .equipment-slot:hover {
            border-color: var(--primary-color);
            background: rgba(56, 189, 248, 0.1);
        }
        
        .slot-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        
        .slot-name {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        
        .slot-item {
            font-size: 0.8rem;
            color: var(--command-color);
            font-weight: bold;
        }
        
        .buff-categories {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .buff-category {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px;
        }
        
        .buff-header {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .buff-details {
            font-size: 0.75rem;
        }
        
        .buff-item {
            padding: 2px 0;
            opacity: 0.9;
        }
        
        .buff-none {
            opacity: 0.6;
            font-style: italic;
        }
        
        .panel-title { 
            font-size: 0.75rem; 
            font-weight: 900; 
            letter-spacing: 2px; 
            margin-bottom: 15px; 
            padding-bottom: 8px; 
            border-bottom: 1px solid var(--border-color); 
            color: var(--primary-color); 
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .total-power {
            color: var(--elder-color);
            font-size: 0.85rem;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .char-action-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; color: var(--text-color); opacity: 0.5; cursor: pointer; font-size: 0.7rem; padding: 2px 6px; }
        .char-action-btn:hover { opacity: 1; color: var(--danger-color); }

        .department-selector { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .dept-btn { background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: bold; transition: 0.2s; flex: 1; min-width: 100px; text-align: center; }
        .dept-btn:hover { border-color: var(--primary-color); }
        .dept-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .dept-btn.training { border-color: var(--elder-color); }
        .dept-btn.training.active { background: var(--elder-color); color: var(--bg-color); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--panel-bg); margin: 5% auto; padding: 30px; border: 1px solid var(--border-color); border-radius: 12px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .modal-close { color: var(--text-color); float: right; font-size: 28px; font-weight: bold; cursor: pointer; opacity: 0.7; }
        .modal-close:hover { opacity: 1; }
        
        .recruit-section { margin-bottom: 30px; }
        .recruit-title { font-size: 1rem; font-weight: bold; color: var(--primary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .job-select { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .job-btn { background: var(--panel-bg); border: 2px solid var(--border-color); color: var(--text-color); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 0.75rem; text-align: center; }
        .job-btn:hover:not(.disabled) { border-color: var(--primary-color); background: rgba(56, 189, 248, 0.1); }
        .job-btn.disabled { opacity: 0.3; cursor: not-allowed; border-color: var(--border-color); }
        
        .applicant-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .applicant-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; cursor: pointer; transition: 0.2s; }
        .applicant-card:hover { border-color: var(--primary-color); background: rgba(56, 189, 248, 0.05); }
        .applicant-name { font-weight: bold; color: var(--primary-color); margin-bottom: 8px; }
        .applicant-job { font-size: 0.7rem; opacity: 0.7; margin-bottom: 10px; }
        .applicant-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.7rem; }
        
        .assignment-select { margin: 15px 0; }
        .assignment-select label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; color: var(--primary-color); }
        .assignment-select select { width: 100%; padding: 10px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.85rem; }
        
        .stat-boost-display {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--command-color);
            border-radius: 6px;
            padding: 10px;
            margin: 15px 0;
            font-size: 0.75rem;
        }
        
        .stat-boost-display .title {
            font-weight: bold;
            color: var(--command-color);
            margin-bottom: 8px;
        }
        
        .stat-boost-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        
        .reserve-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .reserve-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .reserve-card { background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 12px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
        .reserve-card:hover { border-color: var(--primary-color); }
        .reserve-card .name { font-weight: bold; color: var(--primary-color); }
        .reserve-card .job { opacity: 0.7; margin-left: 8px; }

        .battle-section-title { font-size: 0.75rem; font-weight: 900; letter-spacing: 2px; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }
        
        .battle-item { background: rgba(255,255,255,0.03); margin-bottom: 8px; padding: 12px; border-radius: 6px; border-left: 4px solid #475569; font-size: 0.85rem; }
        .battle-item.priority-emergency { border-left-color: var(--danger-color); background: rgba(239, 68, 68, 0.08); }
        .battle-item.work-done { border-left-style: double; border-left-color: var(--work-done-color); }

        .breadcrumb { font-size: 0.6rem; opacity: 0.6; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        .task-item { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; padding: 12px; }
        .indent { margin-left: 20px; border-left: 1px solid var(--border-color); padding-left: 15px; margin-top: 8px; }
        .sub-input-area { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; align-items: center; }
        
        input[type="text"], input[type="date"], select { background: #0f172a; color: white; border: 1px solid var(--border-color); padding: 5px; border-radius: 4px; font-size: 0.7rem; color-scheme: dark; }
        .edit-input { background: transparent !important; border: 1px solid var(--primary-color) !important; color: white; width: 100%; outline: none; }
        
        .tier-label { font-size: 0.6rem; font-weight: 800; padding: 2px 6px; border-radius: 3px; color: white; min-width: 80px; text-align: center; display: inline-block; text-transform: uppercase; }
        .label-0 { background: var(--main-quest-color); }
        .label-1 { background: var(--section-color); }
        .label-2 { background: var(--sub-quest-color); }
        .label-3 { background: var(--command-color); }
        
        .btn-toggle { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; border-radius: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-family: monospace; font-weight: bold; }
        .btn-toggle:hover { background: rgba(255,255,255,0.1); }
        
        .btn-focus { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); cursor: pointer; border-radius: 4px; padding: 0 8px; height: 24px; font-size: 0.6rem; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        .btn-focus:hover { background: var(--primary-color); color: white; }

        .collapsed-hint { font-size: 0.65rem; color: var(--primary-color); margin-left: 10px; opacity: 0.8; }

        .type-tag { font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; margin-right: 5px; font-weight: bold; }
        .type-blitz { background: var(--blitz-color); color: white; }
        .type-steady { background: var(--steady-color); color: white; }
        .deadline-badge { font-size: 0.7rem; background: #334155; padding: 2px 6px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; width: 125px; }

        .btn-action { font-size: 0.7rem; padding: 6px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; margin-top: 8px; transition: 0.2s; }
        .btn-utility { background: #475569; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.65rem; cursor: pointer; }
        .btn-template { background: var(--template-color) !important; font-weight: bold; }
        
        .battle-btn-group { display: flex; gap: 6px; }
        .btn-quick { background: #64748b; color: white; flex: 1; }
        .btn-main { flex: 3; }

        .editable-text { cursor: pointer; flex-grow: 1; padding: 2px 4px; }
        .editable-text:hover { background: rgba(255,255,255,0.05); border-radius: 4px; }

        .mode-template #battle-view, .mode-template #character-panel { display: none; }
        .mode-template .container { grid-template-columns: 1fr; }
        #template-editor { display: none; }
        
        /* Equipment Management Modal Styles */
        .equipment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1100;
        }
        
        .equipment-modal-content {
            background: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .equipment-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--panel-bg);
            z-index: 10;
        }
        
        .equipment-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .equipment-table-container {
            padding: 20px;
        }
        
        .equipment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .equipment-table th {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .equipment-table th:hover {
            background: rgba(56, 189, 248, 0.1);
        }
        
        .equipment-table th.sortable::after {
            content: ' ‚ÜïÔ∏è';
            font-size: 0.7rem;
            opacity: 0.5;
        }
        
        .equipment-table th.sort-asc::after {
            content: ' ‚Üë';
            color: var(--command-color);
            opacity: 1;
        }
        
        .equipment-table th.sort-desc::after {
            content: ' ‚Üì';
            color: var(--command-color);
            opacity: 1;
        }
        
        .equipment-table td {
            border: 1px solid var(--border-color);
            padding: 10px 8px;
            text-align: center;
        }
        
        .equipment-table .stat-cell {
            font-variant-numeric: tabular-nums;
            font-weight: bold;
        }
        
        .equipment-table .stat-cell.empty {
            opacity: 0.3;
            font-weight: normal;
        }
        
        .equipment-table .name-cell {
            text-align: left;
            font-weight: bold;
        }
        
        .equipment-table .rarity-cell {
            font-weight: bold;
            color: var(--elder-color);
        }
        
        .equipment-table tr.equipped {
            color: var(--main-quest-color);
        }
        
        .equipment-table tr.equipped td {
            color: var(--main-quest-color);
        }
        
        .equipment-delete-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            font-weight: bold;
        }
        
        .equipment-delete-btn:hover {
            opacity: 0.8;
        }
        
        .equipment-table tr.equipped .equipment-delete-btn {
            border: 1px solid var(--main-quest-color);
        }
        
        .equipment-empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
            font-style: italic;
        }
        
        /* Boss Battle Modal Styles */
        .boss-battle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1100;
        }
        
        .boss-battle-modal-content {
            background: var(--panel-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .boss-battle-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--panel-bg);
            z-index: 10;
        }
        
        .boss-battle-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--danger-color);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .boss-battle-content {
            padding: 20px;
        }
        
        .boss-battle-section {
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .boss-battle-section h4 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .sacrifice-equipment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .sacrifice-equipment-table th {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 10px 6px;
            text-align: center;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .sacrifice-equipment-table td {
            border: 1px solid var(--border-color);
            padding: 8px 6px;
            text-align: center;
        }
        
        .sacrifice-equipment-table .name-cell {
            text-align: left;
            font-weight: bold;
        }
        
        .sacrifice-equipment-table .stat-cell {
            font-variant-numeric: tabular-nums;
            font-weight: bold;
        }
        
        .sacrifice-equipment-table .stat-cell.empty {
            opacity: 0.3;
            font-weight: normal;
        }
        
        .sacrifice-equipment-table .rarity-cell {
            font-weight: bold;
            color: var(--elder-color);
        }
        
        .sacrifice-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .sacrifice-button {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .sacrifice-button:hover {
            opacity: 0.9;
        }
        
        .sacrifice-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .boss-info {
            display: none;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .boss-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--danger-color);
            margin-bottom: 10px;
        }
        
        .boss-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .boss-stat {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }
        
        .boss-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .boss-stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--danger-color);
        }
        
        .party-info {
            display: none;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--command-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .party-department {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--command-color);
            margin-bottom: 15px;
        }
        
        .party-members {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .party-member {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .party-member-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .party-power-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        
        .power-stat {
            text-align: center;
        }
        
        .power-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .power-value {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .party-power {
            color: var(--command-color);
        }
        
        .boss-power {
            color: var(--danger-color);
        }
        
        .vs-text {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .battle-actions {
            text-align: center;
            margin: 20px 0;
        }
        
        .attack-button {
            background: var(--command-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
        }
        
        .attack-button:hover {
            opacity: 0.9;
        }
        
        .battle-result {
            display: none;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .battle-result.victory {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--command-color);
            color: var(--command-color);
        }
        
        .battle-result.defeat {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        .result-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .result-details {
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        .reward-item {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid var(--elder-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .reward-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--elder-color);
            margin-bottom: 10px;
        }
        
        .new-boss-button {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <header>
        <h1 id="app-title" style="margin:0; letter-spacing: 4px; font-weight: 900; color: var(--primary-color);">QUEST ROOT: STRATEGIC FOCUS</h1>
        
        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.65rem; margin-top: 15px; opacity: 0.7;">
            <span id="mode-label">OPERATIONAL TREE</span>
            <span class="transfer-counter" id="transfer-counter">TRANSFERS: 0/2</span>
            <button class="btn-utility btn-template" onclick="toggleMode()" id="mode-btn">TEMPLATE MODE</button>
        </div>
        
        <div id="system-log" style="position: relative;">
            <button class="btn-clear-log" onclick="clearSystemLog()">CLEAR</button>
        </div>
    </header>

    <div style="grid-column: 1 / span 3; display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px;">
        <button class="btn-utility" style="background: var(--primary-color);" onclick="openPartyManagement()">PARTY MANAGEMENT</button>
        <button class="btn-utility" onclick="openEquipmentManagement()">EQUIPMENT MANAGEMENT</button>
        <button class="btn-utility" onclick="openBossBattle()">BOSS BATTLE</button>
        <button class="btn-utility" onclick="openArchiveTab()">LOGS</button>
        <button class="btn-utility" onclick="exportData()">EXPORT</button>
        <button class="btn-utility" onclick="document.getElementById('file-input').click()">IMPORT</button>
        <button class="btn-utility" onclick="clearAllData()" style="background: var(--danger-color);">WIPE</button>
        <input type="file" id="file-input" style="display:none" onchange="importData(event)">
    </div>

    <main id="world-map">
        <div id="task-container"></div>
    </main>

    <main id="template-editor">
        <div id="template-designer-area"></div>
    </main>

    <aside id="battle-view">
        <div class="battle-section-title" style="color: var(--blitz-color);">
            <span>‚ö° BLITZ OPS</span>
            <span id="count-blitz">0</span>
        </div>
        <div id="list-blitz"></div>
        <div class="battle-section-title" style="color: var(--steady-color);">
            <span>üìä STEADY MONITOR</span>
            <span id="count-steady">0</span>
        </div>
        <div id="list-steady"></div>
    </aside>

    <aside id="character-panel">
        <div class="panel-title">
            <span>üë• PARTY STATUS</span>
            <span class="total-power">‚öîÔ∏è <span id="total-power">0</span></span>
        </div>
        <div class="department-selector" id="dept-selector"></div>
        <div id="character-list"></div>
    </aside>
</div>

<!-- Party Management Modal -->
<div id="party-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closePartyManagement()">&times;</span>
        <h2 style="margin-top:0; color: var(--primary-color);">PARTY MANAGEMENT</h2>
        
        <div style="margin-bottom: 20px;">
            <div style="font-size: 0.85rem; font-weight: bold; margin-bottom: 10px;">SELECT DEPARTMENT:</div>
            <div class="department-selector" id="modal-dept-selector"></div>
        </div>
        
        <div class="recruit-section">
            <div class="recruit-title">RECRUIT NEW MEMBER</div>
            <div class="job-select" id="job-select-area"></div>
            <div id="applicant-area"></div>
        </div>

        <div class="reserve-section">
            <div class="recruit-title">RESERVE MEMBERS (<span id="reserve-count">0</span>)</div>
            <div id="reserve-area" class="reserve-list"></div>
        </div>
    </div>
</div>

<!-- Assignment/Transfer Modal -->
<div id="assignment-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="modal-close" onclick="closeAssignmentModal()">&times;</span>
        <h2 style="margin-top:0; color: var(--command-color);" id="assignment-modal-title">ASSIGN TO DEPARTMENT</h2>
        
        <div style="margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid var(--command-color);">
            <div style="font-weight: bold; margin-bottom: 8px;" id="assign-char-name"></div>
            <div style="font-size: 0.75rem; opacity: 0.8;" id="assign-char-info"></div>
        </div>
        
        <!-- Ëª¢ËÅ∑ÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰∏äÊòáË°®Á§∫ -->
        <div id="stat-boost-container" style="display: none;"></div>
        
        <div class="assignment-select">
            <label id="dept-select-label">ÈÖçÂ±ûÂÖàÈÉ®ÈñÄ:</label>
            <select id="assign-dept-select" onchange="updateJobSelect()"></select>
        </div>
        
        <div class="assignment-select">
            <label>ÊãÖÂΩìËÅ∑Âãô:</label>
            <select id="assign-job-select"></select>
        </div>
        
        <button class="btn-assign" onclick="confirmAssignment()" id="confirm-assignment-btn">‚úì ÈÖçÂ±û„ÇíÁ¢∫ÂÆö</button>
    </div>
</div>

<!-- Equipment Management Modal -->
<div id="equipment-modal" class="equipment-modal">
    <div class="equipment-modal-content">
        <div class="equipment-modal-header">
            <h3>EQUIPMENT MANAGEMENT</h3>
            <button class="close-btn" onclick="closeEquipmentManagement()">√ó</button>
        </div>
        
        <div class="equipment-table-container">
            <div id="equipment-table-wrapper"></div>
        </div>
    </div>
</div>

<!-- Boss Battle Modal -->
<div id="boss-battle-modal" class="boss-battle-modal">
    <div class="boss-battle-modal-content">
        <div class="boss-battle-modal-header">
            <h3>üëπ BOSS BATTLE</h3>
            <button class="close-btn" onclick="closeBossBattle()">√ó</button>
        </div>
        
        <div class="boss-battle-content">
            <!-- Equipment Sacrifice Section -->
            <div class="boss-battle-section" id="sacrifice-section">
                <h4>‚öîÔ∏è Sacrifice Equipment to Summon Boss</h4>
                <div id="sacrifice-equipment-wrapper"></div>
                <button class="sacrifice-button" id="sacrifice-btn" onclick="sacrificeEquipment()" disabled>
                    üî• SACRIFICE SELECTED EQUIPMENT
                </button>
            </div>
            
            <!-- Boss Information Section -->
            <div class="boss-info" id="boss-info">
                <div class="boss-name" id="boss-name"></div>
                <div class="boss-stats">
                    <div class="boss-stat">
                        <div class="boss-stat-label">Level</div>
                        <div class="boss-stat-value" id="boss-level"></div>
                    </div>
                    <div class="boss-stat">
                        <div class="boss-stat-label">Combat Power</div>
                        <div class="boss-stat-value" id="boss-power"></div>
                    </div>
                    <div class="boss-stat">
                        <div class="boss-stat-label">Status</div>
                        <div class="boss-stat-value" id="boss-status">Ready to Fight</div>
                    </div>
                </div>
            </div>
            
            <!-- Party Information Section -->
            <div class="party-info" id="party-info">
                <div class="party-department" id="selected-department"></div>
                <div class="party-members" id="party-members"></div>
                <div class="party-power-comparison">
                    <div class="power-stat party-power">
                        <div class="power-label">Party Power</div>
                        <div class="power-value" id="party-total-power"></div>
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="power-stat boss-power">
                        <div class="power-label">Boss Power</div>
                        <div class="power-value" id="boss-total-power"></div>
                    </div>
                </div>
            </div>
            
            <!-- Battle Actions -->
            <div class="battle-actions" id="battle-actions" style="display: none;">
                <button class="attack-button" onclick="attackBoss()">‚ö° ATTACK!</button>
            </div>
            
            <!-- Battle Result -->
            <div class="battle-result" id="battle-result">
                <div class="result-title" id="result-title"></div>
                <div class="result-details" id="result-details"></div>
                <div id="reward-container"></div>
                <button class="new-boss-button" onclick="resetBossBattle()">Summon New Boss</button>
            </div>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'questRoot_dual_v25';
    const TEMP_KEY = 'questRoot_templates_v25';
    const DEPT_KEY = 'questRoot_departments_v25';
    const RESERVE_KEY = 'questRoot_reserve_v25';
    const LOG_KEY = 'questRoot_systemlog_v25';
    const TRANSFER_KEY = 'questRoot_transfer_v25';
    const EQUIPMENT_KEY = 'questRoot_equipment_v25';
    const OWNED_EQUIPMENT_KEY = 'questRoot_owned_equipment_v25';
    const BOSS_BATTLE_KEY = 'questRoot_boss_battle_v25';
    
    // Boss Battle System Constants
    const BOSS_BASE_MULTIPLIER = 5;
    const BOSS_LEVEL_MULTIPLIERS = {
        1: 1.1,
        2: 1.2,
        3: 1.3,
        4: 1.4,
        5: 1.5
    };
    
    const BOSS_NAMES = {
        1: "Goblin Warrior",
        2: "Orc Champion", 
        3: "Dark Knight",
        4: "Dragon Lord",
        5: "Demon Overlord"
    };
    
    const LEGENDARY_DROP_RATES = {
        1: 0.0,   // 0%
        2: 0.2,   // 20%
        3: 0.4,   // 40%
        4: 0.6,   // 60%
        5: 0.8    // 80%
    };
    
    let tasks = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let templates = JSON.parse(localStorage.getItem(TEMP_KEY)) || [];
    let departments = JSON.parse(localStorage.getItem(DEPT_KEY)) || {};
    let reserveCharacters = JSON.parse(localStorage.getItem(RESERVE_KEY)) || [];
    let systemLogs = JSON.parse(localStorage.getItem(LOG_KEY)) || [];
    let weeklyTransferData = JSON.parse(localStorage.getItem(TRANSFER_KEY)) || initWeeklyTransferData();
    let ownedEquipment = JSON.parse(localStorage.getItem(OWNED_EQUIPMENT_KEY)) || [];
    let bossBattleData = JSON.parse(localStorage.getItem(BOSS_BATTLE_KEY)) || null;
    let equipmentIdCounter = Math.max(...ownedEquipment.map(e => e.instanceId || 0), 0) + 1;
    let currentDepartment = 'training';
    let currentMode = 'map'; 
    let assigningCharacter = null;
    let assigningFromIndex = null;
    let assigningFromDepartment = null;
    let isTransferMode = false;
    
    // Equipment Management System State
    let equipmentSortState = { column: 'rarity', direction: 'desc' };
    
    // ========== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ ==========
    
    function getDepartmentDisplayName(deptId) {
        const config = DEPARTMENT_CONFIG[deptId];
        return config ? config.name : deptId;
    }
    
    function findCharacterById(characterId) {
        for (let deptId in departments) {
            const dept = departments[deptId];
            if (dept && dept.characters) {
                const charIndex = dept.characters.findIndex(c => c && c.id === characterId);
                if (charIndex !== -1) {
                    return {
                        character: dept.characters[charIndex],
                        department: deptId,
                        departmentName: getDepartmentDisplayName(deptId),
                        index: charIndex
                    };
                }
            }
        }
        return null;
    }
    
    function getCharacterDepartment(character) {
        // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅåÁèæÂú®ÊâÄÂ±û„Åó„Å¶„ÅÑ„ÇãÈÉ®ÈñÄ„ÇíËøî„Åô
        // character„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´department„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®
        if (character && character.department) return character.department;
        
        // „Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØÁèæÂú®„ÅÆÈÉ®ÈñÄ„ÇíËøî„ÅôÔºàÁ∞°ÊòìÂÆüË£ÖÔºâ
        return currentDepartment || 'training';
    }
    const labels = ['Main Quest', 'Section', 'Sub-Quest', 'Command'];
    const LEVEL_CAP_FOR_ASSIGNMENT = 5;
    const LEVEL_FOR_TRANSFER = 10;

    const SURNAMES = [
        'Tanaka', 'Suzuki', 'Takahashi', 'Watanabe', 'Ito',
        'Yamamoto', 'Nakamura', 'Kobayashi', 'Kato', 'Yoshida',
        'Yamada', 'Sasaki', 'Matsumoto', 'Inoue', 'Kimura',
        'Hayashi', 'Saito', 'Shimizu', 'Yamaguchi', 'Morita',
        'Ikeda', 'Hashimoto', 'Yamazaki', 'Ishikawa', 'Maeda',
        'Fujita', 'Okada', 'Hasegawa', 'Murakami', 'Kondo',
        'Smith', 'Johnson', 'Williams', 'Brown', 'Jones',
        'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez',
        'Anderson', 'Taylor', 'Thomas', 'Moore', 'Jackson',
        'Martin', 'Lee', 'Thompson', 'White', 'Harris'
    ];

    const DEPARTMENT_CONFIG = {
        training: {
            name: 'Development Center',
            jobs: ['Fresh Graduate', 'Career Hire'],
            isTraining: true,
            expBonus: 1.3,
            buff: null
        },
        business: {
            name: 'Business Development',
            jobs: ['Sales Lead', 'Account Manager', 'Proposal Specialist', 'Market Analyst', 'Commander'],
            buff: { atk: 1.2 }
        },
        operations: {
            name: 'Operations',
            jobs: ['Process Manager', 'Quality Controller', 'Documentation', 'Support Staff', 'Commander'],
            buff: { def: 1.2 }
        },
        planning: {
            name: 'Planning & Strategy',
            jobs: ['Strategic Planner', 'Business Analyst', 'Project Coordinator', 'Research Specialist', 'Commander'],
            buff: { mp: 1.2 }
        },
        production: {
            name: 'Production & Delivery',
            jobs: ['Production Lead', 'Technical Staff', 'Quality Assurance', 'Logistics', 'Commander'],
            buff: { hp: 1.2 }
        },
        corporate: {
            name: 'Corporate Support',
            jobs: ['HR Coordinator', 'Finance Staff', 'Legal & Compliance', 'General Affairs', 'Commander'],
            buff: { hp: 1.1, mp: 1.1, atk: 1.1, def: 1.1 }
        }
    };

    // ========== Equipment System Constants ==========
    
    const EQUIPMENT_DROP_RATE = 0.05; // 5% drop rate
    const EQUIPMENT_RARITY_RATES = {
        1: 0.50, // ‚òÖ1: 50% of drops (2.5% total)
        2: 0.20, // ‚òÖ2: 20% of drops (1.0% total)
        3: 0.15, // ‚òÖ3: 15% of drops (0.75% total)
        4: 0.10, // ‚òÖ4: 10% of drops (0.5% total)
        5: 0.05  // ‚òÖ5: 5% of drops (0.25% total)
    };

    const EQUIPMENT_DATABASE = [
        // ‚òÖ1 Common Equipment (20 items)
        { id: 1, name: 'Iron Sword', type: 'weapon', rarity: 1, statBonus: { atk: 3 } },
        { id: 2, name: 'Wooden Staff', type: 'weapon', rarity: 1, statBonus: { mp: 4, atk: 1 } },
        { id: 3, name: 'Rusty Blade', type: 'weapon', rarity: 1, statBonus: { atk: 5 } },
        { id: 4, name: 'Training Sword', type: 'weapon', rarity: 1, statBonus: { atk: 2, mp: 2 } },
        { id: 5, name: 'Bronze Dagger', type: 'weapon', rarity: 1, statBonus: { atk: 4 } },
        { id: 6, name: 'Leather Armor', type: 'armor', rarity: 1, statBonus: { hp: 5, def: 2 } },
        { id: 7, name: 'Cloth Robe', type: 'armor', rarity: 1, statBonus: { mp: 6, def: 1 } },
        { id: 8, name: 'Padded Vest', type: 'armor', rarity: 1, statBonus: { hp: 7 } },
        { id: 9, name: 'Simple Shield', type: 'armor', rarity: 1, statBonus: { def: 4 } },
        { id: 10, name: 'Work Clothes', type: 'armor', rarity: 1, statBonus: { hp: 4, def: 2 } },
        { id: 11, name: 'Iron Mace', type: 'weapon', rarity: 1, statBonus: { atk: 4 } },
        { id: 12, name: 'Short Bow', type: 'weapon', rarity: 1, statBonus: { atk: 3, mp: 1 } },
        { id: 13, name: 'Stone Hammer', type: 'weapon', rarity: 1, statBonus: { atk: 5 } },
        { id: 14, name: 'Apprentice Wand', type: 'weapon', rarity: 1, statBonus: { mp: 5 } },
        { id: 15, name: 'Iron Spear', type: 'weapon', rarity: 1, statBonus: { atk: 4 } },
        { id: 16, name: 'Hide Armor', type: 'armor', rarity: 1, statBonus: { hp: 6, def: 1 } },
        { id: 17, name: 'Cloth Tunic', type: 'armor', rarity: 1, statBonus: { mp: 5, hp: 2 } },
        { id: 18, name: 'Wooden Shield', type: 'armor', rarity: 1, statBonus: { def: 3 } },
        { id: 19, name: 'Leather Boots', type: 'armor', rarity: 1, statBonus: { def: 2, hp: 2 } },
        { id: 20, name: 'Work Gloves', type: 'armor', rarity: 1, statBonus: { def: 1, hp: 3 } },

        // ‚òÖ2 Uncommon Equipment (12 items)
        { id: 21, name: 'Steel Blade', type: 'weapon', rarity: 2, statBonus: { atk: 12 } },
        { id: 22, name: 'Apprentice Staff', type: 'weapon', rarity: 2, statBonus: { mp: 8, atk: 4 } },
        { id: 23, name: 'Hunter Bow', type: 'weapon', rarity: 2, statBonus: { atk: 10, mp: 2 } },
        { id: 24, name: 'Combat Knife', type: 'weapon', rarity: 2, statBonus: { atk: 11 } },
        { id: 25, name: 'Iron Warhammer', type: 'weapon', rarity: 2, statBonus: { atk: 13 } },
        { id: 26, name: 'Chain Mail', type: 'armor', rarity: 2, statBonus: { hp: 12, def: 5 } },
        { id: 27, name: 'Mage Robe', type: 'armor', rarity: 2, statBonus: { mp: 10, def: 3 } },
        { id: 28, name: 'Steel Shield', type: 'armor', rarity: 2, statBonus: { def: 8 } },
        { id: 29, name: 'Reinforced Vest', type: 'armor', rarity: 2, statBonus: { hp: 10, def: 4 } },
        { id: 30, name: 'Battle Gloves', type: 'armor', rarity: 2, statBonus: { def: 5, atk: 3 } },
        { id: 31, name: 'Elven Sword', type: 'weapon', rarity: 2, statBonus: { atk: 10, mp: 5 } },
        { id: 32, name: 'Dwarven Axe', type: 'weapon', rarity: 2, statBonus: { atk: 14 } },

        // ‚òÖ3 Rare Equipment (8 items)
        { id: 33, name: 'Mithril Edge', type: 'weapon', rarity: 3, statBonus: { atk: 24 } },
        { id: 34, name: 'Wizard Staff', type: 'weapon', rarity: 3, statBonus: { mp: 18, atk: 8 } },
        { id: 35, name: 'Dragon Slayer', type: 'weapon', rarity: 3, statBonus: { atk: 26 } },
        { id: 36, name: 'Enchanted Blade', type: 'weapon', rarity: 3, statBonus: { atk: 20, mp: 6 } },
        { id: 37, name: 'Dragon Scale', type: 'armor', rarity: 3, statBonus: { hp: 22, def: 10 } },
        { id: 38, name: 'Archmage Robe', type: 'armor', rarity: 3, statBonus: { mp: 20, def: 7 } },
        { id: 39, name: 'Titanium Shield', type: 'armor', rarity: 3, statBonus: { def: 15 } },
        { id: 40, name: 'Sacred Armor', type: 'armor', rarity: 3, statBonus: { hp: 18, def: 9 } },

        // ‚òÖ4 Epic Equipment - Department Specific (6 items)
        { id: 41, name: 'Revenue Seeker', type: 'weapon', rarity: 4, statBonus: { atk: 25, mp: 15 }, departmentRestriction: 'business' },
        { id: 42, name: 'Process Shield', type: 'armor', rarity: 4, statBonus: { def: 18, hp: 25 }, departmentRestriction: 'operations' },
        { id: 43, name: 'Mana Crystal', type: 'weapon', rarity: 4, statBonus: { mp: 35, atk: 10 }, departmentRestriction: 'planning' },
        { id: 44, name: 'Titan Hammer', type: 'weapon', rarity: 4, statBonus: { atk: 32, hp: 10 }, departmentRestriction: 'production' },
        { id: 45, name: 'Support Baton', type: 'weapon', rarity: 4, statBonus: { hp: 15, mp: 15, atk: 15, def: 15 }, departmentRestriction: 'corporate' },
        { id: 46, name: 'Training Manual', type: 'armor', rarity: 4, statBonus: { hp: 12, mp: 12, atk: 12, def: 12 }, departmentRestriction: 'training' },

        // ‚òÖ5 Legendary Equipment - Department Specific (4 items)
        { id: 47, name: 'Golden Contract', type: 'weapon', rarity: 5, statBonus: { atk: 35, mp: 25 }, departmentRestriction: 'business' },
        { id: 48, name: 'Perfect System', type: 'armor', rarity: 5, statBonus: { hp: 40, mp: 20, def: 30 }, departmentRestriction: 'operations' },
        { id: 49, name: 'Strategic Vision', type: 'weapon', rarity: 5, statBonus: { mp: 45, atk: 20 }, departmentRestriction: 'planning' },
        { id: 50, name: 'Master Craft', type: 'weapon', rarity: 5, statBonus: { atk: 40, hp: 30 }, departmentRestriction: 'production' }
    ];
    
    const CHARACTER_EQUIPMENT_SLOTS = [
        { slotType: 'weapon', displayName: 'Weapon', icon: '‚öîÔ∏è' },
        { slotType: 'armor', displayName: 'Armor', icon: 'üõ°Ô∏è' }
    ];
    
    const EQUIPMENT_TYPE_KEYWORDS = {
        weapon: ['sword', 'staff', 'blade', 'dagger', 'mace', 'bow', 'hammer', 'wand', 'spear', 'axe', 'edge', 'slayer', 'knife', 'warhammer', 'contract', 'vision', 'craft', 'baton', 'lance', 'sabre', 'saber'],
        armor: ['armor', 'robe', 'vest', 'shield', 'clothes', 'mail', 'boots', 'gloves', 'scale', 'manual', 'system', 'tunic', 'cloak', 'ring', 'amulet', 'charm', 'necklace', 'band', 'bracelet', 'accessory', 'brooch', 'helmet', 'helm', 'cap', 'hat', 'coat', 'jacket', 'uniform', 'mantle', 'cape']
    };
    
    function inferEquipmentSlotType(name = '', statBonus = {}) {
        const lowerName = name.toLowerCase();
        
        if (lowerName) {
            if (EQUIPMENT_TYPE_KEYWORDS.weapon.some(keyword => lowerName.includes(keyword))) return 'weapon';
            if (EQUIPMENT_TYPE_KEYWORDS.armor.some(keyword => lowerName.includes(keyword))) return 'armor';
        }
        
        const atk = statBonus.atk || 0;
        const def = statBonus.def || 0;
        
        if (atk === 0 && def === 0) {
            const hp = statBonus.hp || 0;
            const mp = statBonus.mp || 0;
            if (mp > hp) return 'weapon';
            if (hp >= mp) return 'armor';
        }
        
        if (atk >= def) return 'weapon';
        return 'armor';
    }
    
    function getEquipmentSlotType(equipment) {
        if (!equipment) return null;
        if (equipment.slotType === 'weapon' || equipment.slotType === 'armor') return equipment.slotType;
        if (equipment.type === 'weapon' || equipment.type === 'armor') return equipment.type;
        return inferEquipmentSlotType(equipment.name || '', equipment.statBonus || {});
    }
    
    function getEquippedItemForSlot(characterId, slotType) {
        return ownedEquipment.find(eq => eq?.isEquipped && eq.equippedTo === characterId && getEquipmentSlotType(eq) === slotType) || null;
    }
    
    function normalizeOwnedEquipmentData() {
        if (!Array.isArray(ownedEquipment)) {
            ownedEquipment = [];
            return;
        }
        
        let updated = false;
        
        ownedEquipment.forEach(item => {
            if (!item) return;
            
            if (item.instanceId == null) {
                item.instanceId = equipmentIdCounter++;
                updated = true;
            }
            
            const slotType = getEquipmentSlotType(item);
            if (slotType && item.slotType !== slotType) {
                item.slotType = slotType;
                updated = true;
            }
            
            if (!item.type || (item.type !== 'weapon' && item.type !== 'armor')) {
                if (slotType) {
                    item.type = slotType;
                    updated = true;
                }
            }
        });
        
        const equippedByCharacter = {};
        ownedEquipment.forEach(item => {
            if (!item?.isEquipped || item.equippedTo == null) return;
            
            const slotType = getEquipmentSlotType(item);
            if (!slotType) {
                item.isEquipped = false;
                item.equippedTo = null;
                updated = true;
                return;
            }
            
            const charSlots = equippedByCharacter[item.equippedTo] || (equippedByCharacter[item.equippedTo] = {});
            if (charSlots[slotType]) {
                item.isEquipped = false;
                item.equippedTo = null;
                updated = true;
            } else {
                charSlots[slotType] = item.instanceId;
            }
        });
        
        if (updated) {
            equipmentIdCounter = Math.max(...ownedEquipment.map(e => e?.instanceId || 0), 0) + 1;
            saveOwnedEquipment();
        }
    }
    
    EQUIPMENT_DATABASE.forEach(item => {
        if (!item) return;
        const slotType = getEquipmentSlotType(item);
        if (slotType) {
            item.slotType = slotType;
            if (!item.type || (item.type !== 'weapon' && item.type !== 'armor')) {
                item.type = slotType;
            }
        }
    });
    
    normalizeOwnedEquipmentData();
    
    function initWeeklyTransferData() {
        return {
            weekStartDate: getMondayOfWeek(new Date()),
            transferCount: 0,
            maxTransfers: 2
        };
    }

    function getMondayOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d.setDate(diff));
        monday.setHours(0, 0, 0, 0);
        return monday.toISOString();
    }

    function checkAndResetWeeklyTransfers() {
        const currentMonday = getMondayOfWeek(new Date());
        if (weeklyTransferData.weekStartDate !== currentMonday) {
            weeklyTransferData = {
                weekStartDate: currentMonday,
                transferCount: 0,
                maxTransfers: 2
            };
            saveWeeklyTransferData();
        }
    }

    function canTransferThisWeek() {
        checkAndResetWeeklyTransfers();
        return weeklyTransferData.transferCount < weeklyTransferData.maxTransfers;
    }

    function incrementTransferCount() {
        weeklyTransferData.transferCount++;
        saveWeeklyTransferData();
    }

    function saveWeeklyTransferData() {
        localStorage.setItem(TRANSFER_KEY, JSON.stringify(weeklyTransferData));
    }

    function updateTransferCounter() {
        checkAndResetWeeklyTransfers();
        const counter = document.getElementById('transfer-counter');
        counter.textContent = `TRANSFERS: ${weeklyTransferData.transferCount}/${weeklyTransferData.maxTransfers}`;
        if (weeklyTransferData.transferCount >= weeklyTransferData.maxTransfers) {
            counter.classList.add('limit-reached');
        } else {
            counter.classList.remove('limit-reached');
        }
    }

    // ========== System Log Functions ==========
    
    function addSystemLog(icon, text, badge = null) {
        const timestamp = new Date().toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        systemLogs.push({ icon, text, badge, timestamp });
        
        if (systemLogs.length > 20) {
            systemLogs.shift();
        }
        
        saveSystemLog();
        renderSystemLog();
    }

    function renderSystemLog() {
        const logDiv = document.getElementById('system-log');
        
        if (systemLogs.length === 0) {
            logDiv.innerHTML = '<button class="btn-clear-log" onclick="clearSystemLog()">CLEAR</button>';
            logDiv.classList.remove('active');
            return;
        }
        
        logDiv.classList.add('active');
        logDiv.innerHTML = `
            <button class="btn-clear-log" onclick="clearSystemLog()">CLEAR</button>
            ${systemLogs.map(log => {
                const badgeHtml = log.badge 
                    ? `<span class="log-badge badge-${log.badge.toLowerCase()}">${log.badge}</span>` 
                    : '';
                
                return `
                    <div class="log-entry">
                        <span class="log-time">${log.timestamp}</span>
                        <span class="log-icon">${log.icon}</span>
                        <span class="log-text">${log.text}</span>
                        ${badgeHtml}
                    </div>
                `;
            }).join('')}
        `;
        
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearSystemLog() {
        if (confirm('„Åô„Åπ„Å¶„ÅÆ„É≠„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
            systemLogs = [];
            saveSystemLog();
            renderSystemLog();
        }
    }

    function saveSystemLog() {
        localStorage.setItem(LOG_KEY, JSON.stringify(systemLogs));
    }

    // ========== Level Up System ==========

    function toggleExpPriority(index) {
        const chars = getCurrentCharacters();
        
        chars.forEach(c => {
            if (c && !c.isElder) {
                c.expPriority = false;
            }
        });
        
        const selectedChar = chars[index];
        if (selectedChar && !selectedChar.isElder) {
            selectedChar.expPriority = true;
        }
        
        saveDepartments();
        saveAndRender();
    }

    function processLevelUp() {
        const dept = getCurrentDepartment();
        const isTraining = isTrainingDepartment();
        
        let eligibleChars = dept.characters.filter(c => {
            if (!c || c.isElder) return false;
            if (isTraining && c.level >= 5) return false;
            return true;
        });
        
        if (eligibleChars.length === 0) {
            if (isTraining) {
                addSystemLog('‚ö†Ô∏è', '„Éë„Éº„ÉÜ„Ç£ÂÖ®Âì°„Åå„É¨„Éô„É´‰∏äÈôêÔºàLv.5Ôºâ„Å´ÈÅî„Åó„Å¶„ÅÑ„Åæ„Åô', null);
            }
            return;
        }
        
        const priorityChar = eligibleChars.find(c => c.expPriority === true);
        
        if (isTraining) {
            for (let i = 0; i < 2; i++) {
                if (eligibleChars.length === 0) break;
                
                const randomChar = eligibleChars[Math.floor(Math.random() * eligibleChars.length)];
                const result = levelUpCharacter(randomChar);
                if (result) {
                    addSystemLog('üéâ', `${result.name} Lv.${result.oldLevel} ‚Üí Lv.${result.newLevel} (${result.statName}+1)`, null);
                }
                
                if (randomChar.level >= 5) {
                    eligibleChars = eligibleChars.filter(c => c.id !== randomChar.id);
                }
            }
            
            if (priorityChar && priorityChar.level < 5) {
                const result = levelUpCharacter(priorityChar);
                if (result) {
                    addSystemLog('‚≠ê', `${result.name} Lv.${result.oldLevel} ‚Üí Lv.${result.newLevel} (${result.statName}+1)`, 'PRIORITY');
                }
            }
        } 
        else {
            const randomChar = eligibleChars[Math.floor(Math.random() * eligibleChars.length)];
            const result1 = levelUpCharacter(randomChar);
            if (result1) {
                addSystemLog('üéâ', `${result1.name} Lv.${result1.oldLevel} ‚Üí Lv.${result1.newLevel} (${result1.statName}+1)`, null);
            }
            
            if (priorityChar) {
                const result2 = levelUpCharacter(priorityChar);
                if (result2) {
                    addSystemLog('‚≠ê', `${result2.name} Lv.${result2.oldLevel} ‚Üí Lv.${result2.newLevel} (${result2.statName}+1)`, 'PRIORITY');
                }
            }
        }
        
        saveDepartments();
        saveAndRender();
    }

    function levelUpCharacter(character) {
        if (!character) return null;
        
        const oldLevel = character.level;
        
        if (isTrainingDepartment() && character.level >= 5) {
            return null;
        }
        
        character.level++;
        
        // ÈÉ®ÈñÄÂÜÖ„É¨„Éô„É´„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        if (character.deptLevelCount !== undefined) {
            character.deptLevelCount++;
        }
        
        const stats = ['hp', 'mp', 'atk', 'def'];
        const statNames = { hp: 'HP', mp: 'MP', atk: 'ATK', def: 'DEF' };
        const selectedStat = stats[Math.floor(Math.random() * 4)];
        character.baseStats[selectedStat]++;
        
        return {
            name: character.name,
            oldLevel: oldLevel,
            newLevel: character.level,
            stat: selectedStat,
            statName: statNames[selectedStat]
        };
    }

    // ========== Department & Character System ==========
    
    function initDepartments() {
        if (Object.keys(departments).length === 0) {
            for (let deptId in DEPARTMENT_CONFIG) {
                departments[deptId] = {
                    characters: Array(5).fill(null)
                };
            }
            
            departments.training.characters[4] = {
                id: 'elder-fixed',
                name: 'Elder',
                jobName: 'Elder',
                level: 99,
                exp: 0,
                baseStats: { hp: 30, mp: 30, atk: 30, def: 30 },
                equipment: [null, null],
                isElder: true,
                expPriority: false,
                deptLevelCount: 0,
                currentDepartment: 'training'
            };
            
            saveDepartments();
        }
        
        // Êó¢Â≠ò„Ç≠„É£„É©„ÇØ„Çø„Éº„Å∏„ÅÆÊñ∞„Éï„Ç£„Éº„É´„ÉâËøΩÂä†ÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
        for (let deptId in departments) {
            departments[deptId].characters.forEach(char => {
                if (char && !char.isElder) {
                    if (char.deptLevelCount === undefined) {
                        char.deptLevelCount = 0;
                    }
                    if (char.currentDepartment === undefined) {
                        char.currentDepartment = deptId;
                    }
                }
            });
        }
    }

    function getCurrentDepartment() {
        return departments[currentDepartment];
    }

    function getCurrentCharacters() {
        return getCurrentDepartment().characters;
    }

    function getOccupiedJobs() {
        const chars = getCurrentCharacters();
        return chars.filter(c => c !== null && !c.isElder).map(c => c.jobName);
    }

    function isTrainingDepartment() {
        return DEPARTMENT_CONFIG[currentDepartment].isTraining || false;
    }

    function isTrainingJob(jobName) {
        return jobName === 'Fresh Graduate' || jobName === 'Career Hire';
    }

    function randomStat(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function randomName() {
        return SURNAMES[Math.floor(Math.random() * SURNAMES.length)];
    }

    function generateApplicant(jobName) {
        const baseStats = {
            hp: randomStat(5, 15),
            mp: randomStat(5, 15),
            atk: randomStat(5, 15),
            def: randomStat(5, 15)
        };

        return {
            id: Date.now() + Math.random(),
            name: randomName(),
            jobName: jobName,
            level: 1,
            exp: 0,
            baseStats: baseStats,
            equipment: [null, null],
            expPriority: false,
            deptLevelCount: 0,
            currentDepartment: 'training'
        };
    }

    function applyCommanderDebuff(stats) {
        return {
            hp: Math.floor(stats.hp * 0.7),
            mp: Math.floor(stats.mp * 0.7),
            atk: Math.floor(stats.atk * 0.7),
            def: Math.floor(stats.def * 0.7)
        };
    }

    function getDisplayStats(character) {
        if (!character) return null;
        
        if (character.isElder) {
            return { ...character.baseStats };
        }
        
        const buffSummary = calculateDetailedBuffs(character);
        if (!buffSummary || !buffSummary.finalStats) {
            return { ...character.baseStats };
        }
        
        return { ...buffSummary.finalStats };
    }

    function calculateTotalPower() {
        const chars = getCurrentCharacters();
        let totalPower = 0;
        
        chars.forEach(char => {
            if (char) {
                const stats = getDisplayStats(char);
                totalPower += stats.hp + stats.mp + stats.atk + stats.def;
            }
        });
        
        return totalPower;
    }

    function isReadyForAssignment(character) {
        return character && !character.isElder && isTrainingJob(character.jobName) && character.level >= LEVEL_CAP_FOR_ASSIGNMENT;
    }

    function isReadyForTransfer(character) {
        if (!character || character.isElder) return false;
        if (isTrainingJob(character.jobName)) return false;
        return character.deptLevelCount >= LEVEL_FOR_TRANSFER;
    }

    function saveDepartments() {
        localStorage.setItem(DEPT_KEY, JSON.stringify(departments));
        localStorage.setItem(RESERVE_KEY, JSON.stringify(reserveCharacters));
    }

    // ========== Equipment Drop System ==========
    
    function dropEquipment() {
        // 5%„ÅÆÁ¢∫Áéá„Åß„Éâ„É≠„ÉÉ„Éó
        if (Math.random() > EQUIPMENT_DROP_RATE) {
            return null;
        }
        
        // „É¨„Ç¢„É™„ÉÜ„Ç£„ÇíÊ±∫ÂÆö
        const rand = Math.random();
        let cumulativeRate = 0;
        let selectedRarity = 1;
        
        for (let rarity = 1; rarity <= 5; rarity++) {
            cumulativeRate += EQUIPMENT_RARITY_RATES[rarity];
            if (rand <= cumulativeRate) {
                selectedRarity = rarity;
                break;
            }
        }
        
        // Ë©≤ÂΩì„É¨„Ç¢„É™„ÉÜ„Ç£„ÅÆË£ÖÂÇô„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû
        const availableEquipment = EQUIPMENT_DATABASE.filter(eq => eq.rarity === selectedRarity);
        if (availableEquipment.length === 0) {
            return null;
        }
        
        const selectedEquipment = availableEquipment[Math.floor(Math.random() * availableEquipment.length)];
        const slotType = selectedEquipment.slotType || getEquipmentSlotType(selectedEquipment);
        
        // Êñ∞„Åó„ÅÑË£ÖÂÇô„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
        const newEquipment = {
            instanceId: equipmentIdCounter++,
            id: selectedEquipment.id,
            name: selectedEquipment.name,
            type: slotType || selectedEquipment.type,
            slotType: slotType || selectedEquipment.type,
            rarity: selectedEquipment.rarity,
            statBonus: selectedEquipment.statBonus,
            isEquipped: false,
            equippedTo: null
        };
        
        // ÊâÄÊúâË£ÖÂÇô„Å´ËøΩÂä†
        ownedEquipment.push(newEquipment);
        saveOwnedEquipment();
        
        // „Éâ„É≠„ÉÉ„ÉóÈÄöÁü•
        const rarityStars = '‚òÖ'.repeat(newEquipment.rarity);
        console.log(`üéâ Equipment Drop: ${newEquipment.name} ${rarityStars}`);
        addSystemLog('üéÅ', `Equipment Drop: ${newEquipment.name} ${rarityStars}`, null);
        
        // Ë£ÖÂÇôÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
        const equipmentModal = document.getElementById('equipment-modal');
        if (equipmentModal && equipmentModal.style.display === 'flex') {
            renderEquipmentManagementTable();
        }
        
        return newEquipment;
    }
    
    function saveOwnedEquipment() {
        localStorage.setItem(OWNED_EQUIPMENT_KEY, JSON.stringify(ownedEquipment));
    }

    // ========== Test Functions for Equipment System ==========
    
    function testEquipmentDrop(times = 1) {
        console.log(`=== Equipment Drop Test (${times} times) ===`);
        const results = [];
        
        for (let i = 0; i < times; i++) {
            const result = dropEquipment();
            if (result) {
                results.push({
                    name: result.name,
                    rarity: result.rarity,
                    type: result.type,
                    statBonus: result.statBonus
                });
                console.log(`Drop ${i + 1}: ${result.name} ‚òÖ${result.rarity} (${result.type})`);
            } else {
                console.log(`Drop ${i + 1}: No drop`);
            }
        }
        
        console.log(`=== Results Summary ===`);
        console.log(`Total drops: ${results.length}/${times} (${(results.length/times*100).toFixed(1)}%)`);
        
        const rarityCount = {};
        results.forEach(item => {
            rarityCount[item.rarity] = (rarityCount[item.rarity] || 0) + 1;
        });
        
        for (let rarity = 1; rarity <= 5; rarity++) {
            const count = rarityCount[rarity] || 0;
            const expectedRate = EQUIPMENT_RARITY_RATES[rarity] * EQUIPMENT_DROP_RATE * 100;
            const actualRate = (count / times) * 100;
            console.log(`‚òÖ${rarity}: ${count} drops (Expected: ~${expectedRate.toFixed(2)}%, Actual: ${actualRate.toFixed(2)}%)`);
        }
        
        return results;
    }
    
    function testTaskCompletionWithDrops(times = 10) {
        console.log(`=== Task Completion Test (${times} times) ===`);
        
        // „ÉÜ„Çπ„ÉàÁî®„ÅÆ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
        const testTask = {
            id: 'test-task-' + Date.now(),
            text: 'Test Task for Equipment Drops',
            workDone: false,
            reportDone: false,
            parentId: null
        };
        
        tasks.push(testTask);
        
        let totalDrops = 0;
        for (let i = 0; i < times; i++) {
            // „Çø„Çπ„ÇØ„ÇíÊú™ÂÆå‰∫ÜÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà
            testTask.workDone = false;
            testTask.reportDone = false;
            
            // „Çø„Çπ„ÇØÂÆå‰∫ÜÔºà„Éâ„É≠„ÉÉ„Éó‰ªò„ÅçÔºâ
            quickFinish(testTask.id);
            
            // „Éâ„É≠„ÉÉ„Éó„ÅåÁô∫Áîü„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const lastItem = ownedEquipment[ownedEquipment.length - 1];
            if (lastItem && lastItem.equipmentId) {
                totalDrops++;
                console.log(`Task ${i + 1}: Equipment drop - ${lastItem.name} ‚òÖ${lastItem.rarity}`);
            } else {
                console.log(`Task ${i + 1}: No equipment drop`);
            }
        }
        
        // „ÉÜ„Çπ„Éà„Çø„Çπ„ÇØ„ÇíÂâäÈô§
        tasks = tasks.filter(t => t.id !== testTask.id);
        saveAndRender();
        
        console.log(`=== Task Completion Results ===`);
        console.log(`Total tasks: ${times}`);
        console.log(`Equipment drops: ${totalDrops}`);
        console.log(`Drop rate: ${(totalDrops/times*100).toFixed(1)}% (Expected: ~5%)`);
        
        return { totalTasks: times, totalDrops, dropRate: totalDrops/times };
    }
    
    function showOwnedEquipment() {
        console.log('=== Owned Equipment ===');
        if (ownedEquipment.length === 0) {
            console.log('No equipment owned');
            return;
        }
        
        ownedEquipment.forEach((item, index) => {
            const rarityStars = '‚òÖ'.repeat(item.rarity);
            const equippedText = item.isEquipped ? ` (Equipped to character ${item.equippedTo})` : ' (Not equipped)';
            console.log(`${index + 1}. ${item.name} ${rarityStars} - ${item.type}${equippedText}`);
            console.log(`   Stats:`, item.statBonus);
        });
    }
    
    function clearTestEquipment() {
        const testItems = ownedEquipment.filter(eq => eq.name && eq.name.includes('Test'));
        if (testItems.length > 0) {
            ownedEquipment = ownedEquipment.filter(eq => !eq.name.includes('Test'));
            saveOwnedEquipment();
            console.log(`Cleared ${testItems.length} test equipment items`);
        }
    }

    function switchDepartment(deptId) {
        currentDepartment = deptId;
        saveAndRender();
    }

    function renderDepartmentSelector(containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        for (let deptId in DEPARTMENT_CONFIG) {
            const config = DEPARTMENT_CONFIG[deptId];
            const btn = document.createElement('button');
            btn.className = `dept-btn ${deptId === currentDepartment ? 'active' : ''} ${config.isTraining ? 'training' : ''}`;
            btn.textContent = config.name;
            btn.onclick = () => {
                switchDepartment(deptId);
                if (containerId === 'modal-dept-selector') {
                    renderJobButtons();
                    document.getElementById('applicant-area').innerHTML = '';
                }
            };
            container.appendChild(btn);
        }
    }

    function renderCharacters() {
        const container = document.getElementById('character-list');
        container.innerHTML = '';
        
        const chars = getCurrentCharacters();
        const commanderIndex = 4;
        
        for (let i = 0; i < 4; i++) {
            const char = chars[i];
            if (char) {
                container.appendChild(createCharacterCard(char, i, false));
            } else {
                container.appendChild(createEmptyCard(i, false));
            }
        }
        
        const commander = chars[commanderIndex];
        if (commander) {
            container.appendChild(createCharacterCard(commander, commanderIndex, true));
        } else {
            container.appendChild(createEmptyCard(commanderIndex, true));
        }
        
        document.getElementById('total-power').innerText = calculateTotalPower();
    }

    function createCharacterCard(char, index, isCommander) {
        const card = document.createElement('div');
        const isElder = char.isElder || false;
        const ready = isReadyForAssignment(char) && isTrainingDepartment();
        const transferReady = isReadyForTransfer(char) && !isTrainingDepartment();
        
        card.className = `character-card ${isCommander ? (isElder ? 'elder' : 'commander') : ''} ${ready ? 'ready-for-assignment' : ''} ${transferReady ? 'ready-for-transfer' : ''}`;
        
        const displayStats = getDisplayStats(char);
        const baseStats = char.baseStats;
        
        const bonuses = {
            hp: displayStats.hp - baseStats.hp,
            mp: displayStats.mp - baseStats.mp,
            atk: displayStats.atk - baseStats.atk,
            def: displayStats.def - baseStats.def
        };
        
        const hasCommander = getCurrentCharacters().some(c => c && (c.jobName === 'Commander' || c.isElder));
        const deptConfig = DEPARTMENT_CONFIG[currentDepartment];
        const hasBuff = (deptConfig.buff !== null || hasCommander) && !isElder;
        
        const readyBadge = ready ? '<div class="ready-badge">‚úì READY</div>' : '';
        const transferReadyBadge = transferReady ? '<div class="transfer-ready-badge">‚ö° TRANSFER</div>' : '';
        const actionBtn = isElder ? '' : `<button class="char-action-btn" onclick="event.stopPropagation(); showCharacterMenu(${index})">‚ãÆ</button>`;
        
        const canTransfer = canTransferThisWeek();
        const assignBtn = ready ? `<button class="btn-assign" onclick="openAssignmentModal(${index}, false)">ASSIGN TO DEPARTMENT</button>` : '';
        const transferBtn = transferReady ? `<button class="btn-transfer" ${!canTransfer ? 'disabled' : ''} onclick="${canTransfer ? `openAssignmentModal(${index}, true)` : ''}">TRANSFER DEPARTMENT</button>` : '';
        
        const expPriorityBtn = !isElder ? `
            <button class="exp-priority-btn ${char.expPriority ? 'active' : ''}" 
                    onclick="toggleExpPriority(${index})">
                ‚≠ê EXP PRIORITY
            </button>
        ` : '';
        
        const levelCapWarning = (isTrainingDepartment() && char.level >= 5 && !isElder) ? `
            <div class="level-cap-warning">
                ‚ö†Ô∏è LEVEL CAP (ASSIGN TO DEPARTMENT)
            </div>
        ` : '';
        
        const nameClass = transferReady ? 'transfer-ready' : '';
        
        const formatStat = (stat, value, bonus) => {
            const bonusText = bonus !== 0 ? `<span class="stat-bonus">(+${bonus})</span>` : '';
            const colorClass = hasBuff ? 'buffed' : '';
            return `
                <div class="stat-item">
                    <span class="stat-label">${stat}</span>
                    <span class="stat-value ${colorClass}">${value}${bonusText}</span>
                </div>
            `;
        };
        
        card.innerHTML = `
            ${readyBadge}
            ${transferReadyBadge}
            ${actionBtn}
            <div class="character-header">
                <div>
                    <div class="character-name ${nameClass}">${char.name}</div>
                    <div class="character-job">${char.jobName}</div>
                </div>
                <div style="font-size: 0.7rem; color: var(--primary-color);">Lv.${char.level}</div>
            </div>
            <div class="character-stats">
                ${formatStat('HP', displayStats.hp, bonuses.hp)}
                ${formatStat('MP', displayStats.mp, bonuses.mp)}
                ${formatStat('ATK', displayStats.atk, bonuses.atk)}
                ${formatStat('DEF', displayStats.def, bonuses.def)}
            </div>
            ${expPriorityBtn}
            ${levelCapWarning}
            ${assignBtn}
            ${transferBtn}
        `;
        
        // „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´„Åô„Çã
        card.style.cursor = 'pointer';
        card.onclick = (event) => {
            // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅØ„Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞„ÇíÈñã„Åã„Å™„ÅÑ
            if (event.target.tagName === 'BUTTON') return;
            showCharacterEquipmentModal(char, index);
        };
        
        return card;
    }

    function createEmptyCard(index, isCommander) {
        const card = document.createElement('div');
        card.className = `character-card empty ${isCommander ? 'commander' : ''}`;
        card.innerHTML = `<div style="text-align:center; font-size:0.75rem; opacity:0.7;">
            ${isCommander ? '‚≠ê COMMANDER<br>PROMOTE FROM TEAM' : '‚ûï RECRUIT<br>MEMBER'}
        </div>`;
        if (!isCommander) {
            card.onclick = () => openPartyManagement();
        }
        return card;
    }

    function showCharacterMenu(index) {
        const chars = getCurrentCharacters();
        const char = chars[index];
        if (!char || char.isElder) return;
        
        if (confirm(`${char.name}„Çí‰øùÁïô„É™„Çπ„Éà„Å´ÁßªÂãï„Åó„Åæ„Åô„Åã?`)) {
            reserveCharacters.push(char);
            chars[index] = null;
            saveDepartments();
            saveAndRender();
        }
    }

    // ========== Detailed Character Equipment & Buff UI ==========
    
    function showCharacterEquipmentModal(character, index) {
        if (!character) return;
        
        const modal = document.createElement('div');
        modal.className = 'character-equipment-modal';
        modal.id = 'character-equipment-modal';
        
        const buffs = calculateDetailedBuffs(character);
        const equipmentSlots = getCharacterEquipmentSlots(character);
        const formatDiff = (value) => value >= 0 ? `(+${value})` : `(${value})`;
        
        modal.innerHTML = `
            <div class="character-equipment-content">
                <div class="modal-header">
                    <h3>${character.name} - Character Overview</h3>
                    <button class="close-btn" onclick="closeCharacterEquipmentModal()">√ó</button>
                </div>
                
                <div class="modal-body">
                    <!-- Base Stats -->
                    <div class="stats-section">
                        <h4>Stats</h4>
                        <div class="stats-grid">
                            <div class="stat-row">
                                <span class="stat-label">HP:</span>
                                <span class="stat-value">${character.baseStats.hp} ‚Üí ${buffs.finalStats.hp} ${formatDiff(buffs.total.hp)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">MP:</span>
                                <span class="stat-value">${character.baseStats.mp} ‚Üí ${buffs.finalStats.mp} ${formatDiff(buffs.total.mp)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">ATK:</span>
                                <span class="stat-value">${character.baseStats.atk} ‚Üí ${buffs.finalStats.atk} ${formatDiff(buffs.total.atk)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">DEF:</span>
                                <span class="stat-value">${character.baseStats.def} ‚Üí ${buffs.finalStats.def} ${formatDiff(buffs.total.def)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equipment Slots -->
                    <div class="equipment-section">
                        <h4>Equipment</h4>
                        <div class="equipment-slots">
                            ${equipmentSlots.map(slot => `
                                <div class="equipment-slot" onclick="toggleEquipmentSlot(${character.id}, '${slot.slotType}')">
                                    <div class="slot-icon">${slot.icon}</div>
                                    <div class="slot-name">${slot.name}</div>
                                    <div class="slot-item">${slot.equipped ? slot.equipped.name : 'Empty'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Buff Details -->
                    <div class="buffs-section">
                        <h4>Buff Breakdown</h4>
                        <div class="buff-categories">
                            <div class="buff-category">
                                <div class="buff-header">üîß Equipment Bonus</div>
                                <div class="buff-details">
                                    ${renderBuffDetails(character, 'equipment', buffs)}
                                </div>
                            </div>
                            <div class="buff-category">
                                <div class="buff-header">üëë Commander Bonus</div>
                                <div class="buff-details">
                                    ${renderBuffDetails(character, 'commander', buffs)}
                                </div>
                            </div>
                            <div class="buff-category">
                                <div class="buff-header">üè¢ Department Bonus</div>
                                <div class="buff-details">
                                    ${renderBuffDetails(character, 'department', buffs)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        modal.onclick = (e) => {
            if (e.target === modal) closeCharacterEquipmentModal();
        };
    }
    
    function closeCharacterEquipmentModal() {
        const modal = document.getElementById('character-equipment-modal');
        if (modal) modal.remove();
    }
    
    function getCharacterEquipmentSlots(character) {
        if (!character) return [];
        
        return CHARACTER_EQUIPMENT_SLOTS.map(slotInfo => {
            const equipped = getEquippedItemForSlot(character.id, slotInfo.slotType);
            
            return {
                slotType: slotInfo.slotType,
                icon: slotInfo.icon,
                name: slotInfo.displayName,
                equipped
            };
        });
    }
    
    const EQUIPMENT_STAT_LABELS = { hp: 'HP', mp: 'MP', atk: 'ATK', def: 'DEF' };
    const EQUIPMENT_STAT_ORDER = ['hp', 'mp', 'atk', 'def'];
    
    function formatEquipmentStatSummary(statBonus = {}) {
        const parts = [];
        EQUIPMENT_STAT_ORDER.forEach(stat => {
            const value = statBonus[stat];
            if (typeof value === 'number' && value !== 0) {
                const label = EQUIPMENT_STAT_LABELS[stat] || stat.toUpperCase();
                const prefix = value >= 0 ? '+' : '';
                parts.push(`${label} ${prefix}${value}`);
            }
        });
        return parts.length > 0 ? ` (${parts.join(', ')})` : '';
    }
    
    function toggleEquipmentSlot(characterId, slotType) {
        if (!slotType) return;
        
        const slotLabel = slotType === 'weapon' ? 'Weapon' : 'Armor';
        const currentEquipped = getEquippedItemForSlot(characterId, slotType);
        const availableEquipment = ownedEquipment.filter(eq => {
            if (!eq) return false;
            const eqSlotType = getEquipmentSlotType(eq);
            return eqSlotType === slotType && (!eq.isEquipped || eq.equippedTo === characterId);
        });
        
        if (!currentEquipped && availableEquipment.length === 0) {
            alert(`No ${slotLabel.toLowerCase()} items available.`);
            return;
        }
        
        const optionLines = availableEquipment.map(eq => {
            const identifier = eq.instanceId != null ? eq.instanceId : eq.id;
            const equippedSuffix = eq.isEquipped ? ' [Equipped]' : '';
            const statSummary = formatEquipmentStatSummary(eq.statBonus);
            return `${identifier}: ${eq.name}${statSummary}${equippedSuffix}`;
        });
        
        if (currentEquipped) {
            optionLines.unshift('0: Unequip');
        }
        
        const promptMessage = `Select ${slotLabel} equipment:\n${optionLines.join('\n')}\n\nEnter equipment ID or name:`;
        const input = prompt(promptMessage);
        if (input === null) return;
        
        const trimmed = input.trim();
        if (!trimmed) return;
        
        if (trimmed === '0' && currentEquipped) {
            currentEquipped.isEquipped = false;
            currentEquipped.equippedTo = null;
            saveOwnedEquipment();
            refreshCharacterEquipmentModal(characterId);
            return;
        }
        
        const selectedEquipment = availableEquipment.find(eq => {
            const identifier = String(eq.instanceId != null ? eq.instanceId : eq.id);
            return identifier === trimmed || eq.name === trimmed;
        });
        
        if (!selectedEquipment) {
            alert('Invalid input. Please try again.');
            return;
        }
        
        ownedEquipment.forEach(eq => {
            if (!eq) return;
            if (eq.isEquipped && eq.equippedTo === characterId && getEquipmentSlotType(eq) === slotType) {
                eq.isEquipped = false;
                eq.equippedTo = null;
            }
        });
        
        selectedEquipment.isEquipped = true;
        selectedEquipment.equippedTo = characterId;
        selectedEquipment.slotType = slotType;
        selectedEquipment.type = slotType;
        
        saveOwnedEquipment();
        refreshCharacterEquipmentModal(characterId);
        
        // Ë£ÖÂÇôÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
        const equipmentModal = document.getElementById('equipment-modal');
        if (equipmentModal && equipmentModal.style.display === 'flex') {
            renderEquipmentManagementTable();
        }
    }
    
    function refreshCharacterEquipmentModal(characterId) {
        const modal = document.getElementById('character-equipment-modal');
        if (!modal) return;
        
        const characters = getCurrentCharacters();
        const character = characters.find(c => c && c.id === characterId);
        
        if (!character) {
            closeCharacterEquipmentModal();
            return;
        }
        
        showCharacterEquipmentModal(character, characters.indexOf(character));
    }
    
    // ========== Equipment Management System ==========
    
    function openEquipmentManagement() {
        const modal = document.getElementById('equipment-modal');
        modal.style.display = 'flex';
        renderEquipmentManagementTable();
        
        // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        modal.onclick = (e) => {
            if (e.target === modal) closeEquipmentManagement();
        };
    }
    
    function closeEquipmentManagement() {
        const modal = document.getElementById('equipment-modal');
        if (modal) modal.style.display = 'none';
    }
    
    function renderEquipmentManagementTable() {
        const wrapper = document.getElementById('equipment-table-wrapper');
        
        if (!ownedEquipment || ownedEquipment.length === 0) {
            wrapper.innerHTML = '<div class="equipment-empty-state">No equipment owned.</div>';
            return;
        }
        
        // „ÇΩ„Éº„ÉàÂá¶ÁêÜ
        const sortedEquipment = [...ownedEquipment].sort((a, b) => {
            return compareEquipmentItems(a, b, equipmentSortState.column, equipmentSortState.direction);
        });
        
        // „ÉÜ„Éº„Éñ„É´ÁîüÊàê
        const tableHtml = `
            <table class="equipment-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="setEquipmentSort('name')">
                            Name${getSortIndicator('name')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('hp')">
                            HP${getSortIndicator('hp')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('mp')">
                            MP${getSortIndicator('mp')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('atk')">
                            ATK${getSortIndicator('atk')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('def')">
                            DEF${getSortIndicator('def')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('rarity')">
                            Rarity${getSortIndicator('rarity')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('restriction')">
                            Restriction${getSortIndicator('restriction')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('equippedDept')">
                            Equipped Dept.${getSortIndicator('equippedDept')}
                        </th>
                        <th class="sortable" onclick="setEquipmentSort('equippedBy')">
                            Equipped By${getSortIndicator('equippedBy')}
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedEquipment.map(item => createEquipmentTableRow(item)).join('')}
                </tbody>
            </table>
        `;
        
        wrapper.innerHTML = tableHtml;
    }
    
    function getSortIndicator(column) {
        if (equipmentSortState.column !== column) return '';
        return equipmentSortState.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
    }
    
    function setEquipmentSort(column) {
        if (equipmentSortState.column === column) {
            // Âêå„ÅòÂàó„Çí„ÇØ„É™„ÉÉ„ÇØÔºöÊñπÂêë„ÇíÂàá„ÇäÊõø„Åà
            equipmentSortState.direction = equipmentSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            // Áï∞„Å™„ÇãÂàó„Çí„ÇØ„É™„ÉÉ„ÇØÔºöÊñ∞„Åó„ÅÑÂàó„Åß„ÇΩ„Éº„Éà
            equipmentSortState.column = column;
            // Êï∞ÂÄ§Âàó„ÅØÈôçÈ†Ü„ÄÅÊñáÂ≠óÂàóÂàó„ÅØÊòáÈ†Ü„Åß„Çπ„Çø„Éº„Éà
            const numericColumns = ['hp', 'mp', 'atk', 'def', 'rarity'];
            equipmentSortState.direction = numericColumns.includes(column) ? 'desc' : 'asc';
        }
        
        renderEquipmentManagementTable();
    }
    
    function compareEquipmentItems(a, b, column, direction) {
        let valueA, valueB;
        
        switch (column) {
            case 'name':
                valueA = (a.name || '(Unnamed Equipment)').toLowerCase();
                valueB = (b.name || '(Unnamed Equipment)').toLowerCase();
                break;
            case 'hp':
            case 'mp':
            case 'atk':
            case 'def':
                valueA = (a.statBonus && a.statBonus[column]) || 0;
                valueB = (b.statBonus && b.statBonus[column]) || 0;
                break;
            case 'rarity':
                valueA = a.rarity || 0;
                valueB = b.rarity || 0;
                break;
            case 'restriction':
                valueA = a.departmentRestriction ? getDepartmentDisplayName(a.departmentRestriction).toLowerCase() : '';
                valueB = b.departmentRestriction ? getDepartmentDisplayName(b.departmentRestriction).toLowerCase() : '';
                break;
            case 'equippedDept':
                const charInfoA = a.isEquipped ? findCharacterById(a.equippedTo) : null;
                const charInfoB = b.isEquipped ? findCharacterById(b.equippedTo) : null;
                valueA = charInfoA ? charInfoA.departmentName.toLowerCase() : '';
                valueB = charInfoB ? charInfoB.departmentName.toLowerCase() : '';
                break;
            case 'equippedBy':
                const charA = a.isEquipped ? findCharacterById(a.equippedTo) : null;
                const charB = b.isEquipped ? findCharacterById(b.equippedTo) : null;
                valueA = charA ? charA.character.name.toLowerCase() : '';
                valueB = charB ? charB.character.name.toLowerCase() : '';
                break;
            default:
                return 0;
        }
        
        if (valueA < valueB) return direction === 'asc' ? -1 : 1;
        if (valueA > valueB) return direction === 'asc' ? 1 : -1;
        return 0;
    }
    
    function createEquipmentTableRow(item) {
        const isEquipped = item.isEquipped || false;
        const equippedCharInfo = isEquipped ? findCharacterById(item.equippedTo) : null;
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        const formatStat = (stat) => {
            const value = (item.statBonus && item.statBonus[stat]) || 0;
            if (value === 0) {
                return '<td class="stat-cell empty">‚Äî</td>';
            }
            return `<td class="stat-cell">${value >= 0 ? '+' : ''}${value}</td>`;
        };
        
        // „É¨„Ç¢„É™„ÉÜ„Ç£Ë°®Á§∫
        const rarityDisplay = item.rarity ? '‚òÖ'.repeat(item.rarity) : '‚Äî';
        
        // ÈÉ®ÈñÄÂà∂ÈôêË°®Á§∫
        const restrictionDisplay = item.departmentRestriction 
            ? getDepartmentDisplayName(item.departmentRestriction) 
            : '‚Äî';
        
        // Ë£ÖÂÇô‰∏≠ÊÉÖÂ†±Ë°®Á§∫
        const equippedDeptDisplay = equippedCharInfo ? equippedCharInfo.departmentName : '‚Äî';
        const equippedByDisplay = equippedCharInfo ? equippedCharInfo.character.name : '‚Äî';
        
        const rowClass = isEquipped ? 'equipped' : '';
        const itemName = item.name || '(Unnamed Equipment)';
        
        return `
            <tr class="${rowClass}">
                <td class="name-cell">${itemName}</td>
                ${formatStat('hp')}
                ${formatStat('mp')}
                ${formatStat('atk')}
                ${formatStat('def')}
                <td class="rarity-cell">${rarityDisplay}</td>
                <td>${restrictionDisplay}</td>
                <td>${equippedDeptDisplay}</td>
                <td>${equippedByDisplay}</td>
                <td>
                    <button class="equipment-delete-btn" onclick="confirmDeleteEquipment(${item.instanceId})">
                        DELETE
                    </button>
                </td>
            </tr>
        `;
    }
    
    function confirmDeleteEquipment(instanceId) {
        const item = ownedEquipment.find(eq => eq.instanceId === instanceId);
        if (!item) {
            alert('Equipment not found.');
            return;
        }
        
        let confirmMessage = `Are you sure you want to delete "${item.name || 'Unnamed Equipment'}"?`;
        
        if (item.isEquipped) {
            const equippedCharInfo = findCharacterById(item.equippedTo);
            if (equippedCharInfo) {
                confirmMessage = `"${item.name || 'Unnamed Equipment'}" is currently equipped by ${equippedCharInfo.character.name} in ${equippedCharInfo.departmentName}.\n\nThis will unequip the item and delete it permanently. Continue?`;
            }
        }
        
        if (confirm(confirmMessage)) {
            // Ë£ÖÂÇô‰∏≠„ÅÆÂ†¥Âêà„ÅØË£ÖÂÇô„ÇíÂ§ñ„Åô
            if (item.isEquipped) {
                item.isEquipped = false;
                item.equippedTo = null;
                addSystemLog('üîß', `${item.name || 'Equipment'} was unequipped and deleted`, null);
            }
            
            // Ë£ÖÂÇô„ÇíÂâäÈô§
            const index = ownedEquipment.findIndex(eq => eq.instanceId === instanceId);
            if (index !== -1) {
                ownedEquipment.splice(index, 1);
                saveOwnedEquipment();
                saveAndRender();
                renderEquipmentManagementTable();
                
                // „Ç≠„É£„É©„ÇØ„Çø„ÉºË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
                const charModal = document.getElementById('character-equipment-modal');
                if (charModal && item.isEquipped) {
                    refreshCharacterEquipmentModal(item.equippedTo);
                }
                
                addSystemLog('üóëÔ∏è', `${item.name || 'Equipment'} was deleted`, null);
            }
        }
    }
    
    // ========== Boss Battle System ==========
    
    function openBossBattle() {
        const modal = document.getElementById('boss-battle-modal');
        modal.style.display = 'flex';
        renderBossBattleInterface();
        
        // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        modal.onclick = (e) => {
            if (e.target === modal) closeBossBattle();
        };
    }
    
    function closeBossBattle() {
        const modal = document.getElementById('boss-battle-modal');
        if (modal) modal.style.display = 'none';
    }
    
    function renderBossBattleInterface() {
        // „Éú„ÇπÂè¨ÂñöÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (bossBattleData && bossBattleData.boss) {
            renderBossInfo();
            renderPartyInfo();
            document.getElementById('sacrifice-section').style.display = 'none';
            document.getElementById('battle-actions').style.display = 'block';
            
            if (bossBattleData.battleResult) {
                renderBattleResult();
            }
        } else {
            renderSacrificeEquipmentTable();
            document.getElementById('boss-info').style.display = 'none';
            document.getElementById('party-info').style.display = 'none';
            document.getElementById('battle-actions').style.display = 'none';
            document.getElementById('battle-result').style.display = 'none';
            document.getElementById('sacrifice-section').style.display = 'block';
        }
    }
    
    function renderSacrificeEquipmentTable() {
        const wrapper = document.getElementById('sacrifice-equipment-wrapper');
        
        if (!ownedEquipment || ownedEquipment.length === 0) {
            wrapper.innerHTML = '<div class="equipment-empty-state">No equipment available for sacrifice.</div>';
            document.getElementById('sacrifice-btn').disabled = true;
            return;
        }
        
        // „ÉÜ„Éº„Éñ„É´ÁîüÊàê
        const tableHtml = `
            <table class="sacrifice-equipment-table">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Name</th>
                        <th>HP</th>
                        <th>MP</th>
                        <th>ATK</th>
                        <th>DEF</th>
                        <th>Rarity</th>
                        <th>Restriction</th>
                        <th>Equipped By</th>
                    </tr>
                </thead>
                <tbody>
                    ${ownedEquipment.map(item => createSacrificeTableRow(item)).join('')}
                </tbody>
            </table>
        `;
        
        wrapper.innerHTML = tableHtml;
        updateSacrificeButton();
    }
    
    function createSacrificeTableRow(item) {
        const isEquipped = item.isEquipped || false;
        const equippedCharInfo = isEquipped ? findCharacterById(item.equippedTo) : null;
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        const formatStat = (stat) => {
            const value = (item.statBonus && item.statBonus[stat]) || 0;
            if (value === 0) {
                return '<td class="stat-cell empty">‚Äî</td>';
            }
            return `<td class="stat-cell">${value >= 0 ? '+' : ''}${value}</td>`;
        };
        
        // „É¨„Ç¢„É™„ÉÜ„Ç£Ë°®Á§∫
        const rarityDisplay = item.rarity ? '‚òÖ'.repeat(item.rarity) : '‚Äî';
        
        // ÈÉ®ÈñÄÂà∂ÈôêË°®Á§∫
        const restrictionDisplay = item.departmentRestriction 
            ? getDepartmentDisplayName(item.departmentRestriction) 
            : '‚Äî';
        
        // Ë£ÖÂÇô‰∏≠ÊÉÖÂ†±Ë°®Á§∫
        const equippedByDisplay = equippedCharInfo ? equippedCharInfo.character.name : '‚Äî';
        
        const itemName = item.name || '(Unnamed Equipment)';
        
        return `
            <tr>
                <td>
                    <input type="checkbox" class="sacrifice-checkbox" 
                           data-instance-id="${item.instanceId}" 
                           onchange="updateSacrificeButton()">
                </td>
                <td class="name-cell">${itemName}</td>
                ${formatStat('hp')}
                ${formatStat('mp')}
                ${formatStat('atk')}
                ${formatStat('def')}
                <td class="rarity-cell">${rarityDisplay}</td>
                <td>${restrictionDisplay}</td>
                <td>${equippedByDisplay}</td>
            </tr>
        `;
    }
    
    function updateSacrificeButton() {
        const checkboxes = document.querySelectorAll('.sacrifice-checkbox:checked');
        const button = document.getElementById('sacrifice-btn');
        button.disabled = checkboxes.length === 0;
    }
    
    function sacrificeEquipment() {
        const checkboxes = document.querySelectorAll('.sacrifice-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Please select at least one equipment to sacrifice.');
            return;
        }
        
        // ÈÅ∏Êäû„Åï„Çå„ÅüË£ÖÂÇô„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó
        const sacrificedItems = [];
        let totalRarity = 0;
        
        checkboxes.forEach(checkbox => {
            const instanceId = parseInt(checkbox.getAttribute('data-instance-id'));
            const item = ownedEquipment.find(eq => eq.instanceId === instanceId);
            if (item) {
                sacrificedItems.push(item);
                totalRarity += item.rarity || 1;
            }
        });
        
        // „É¨„Ç¢„É™„ÉÜ„Ç£ÂêàË®à„ÇíÊúÄÂ§ß5„Å´Âà∂Èôê
        const bossLevel = Math.min(totalRarity, 5);
        
        // Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏
        const itemNames = sacrificedItems.map(item => item.name || 'Unnamed Equipment').join(', ');
        if (!confirm(`Sacrifice ${sacrificedItems.length} equipment(s): ${itemNames}\n\nThis will summon a Level ${bossLevel} boss. Continue?`)) {
            return;
        }
        
        // Ë£ÖÂÇô„ÇíÂâäÈô§ÔºàË£ÖÂÇô‰∏≠„ÅÆÂ†¥Âêà„ÅØËß£Èô§Ôºâ
        sacrificedItems.forEach(item => {
            if (item.isEquipped) {
                item.isEquipped = false;
                item.equippedTo = null;
            }
            
            const index = ownedEquipment.findIndex(eq => eq.instanceId === item.instanceId);
            if (index !== -1) {
                ownedEquipment.splice(index, 1);
            }
        });
        
        saveOwnedEquipment();
        
        // „Éú„ÇπÂè¨Âñö
        summonBoss(bossLevel, sacrificedItems);
        
        // UIÊõ¥Êñ∞
        renderBossBattleInterface();
        saveAndRender();
    }
    
    function summonBoss(level, sacrificedItems) {
        // ÂÖ®„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂπ≥ÂùáÊà¶Âäõ„ÇíË®àÁÆó
        const allCharacters = [];
        for (let deptId in departments) {
            const dept = departments[deptId];
            if (dept && dept.characters) {
                dept.characters.forEach(char => {
                    if (char) {
                        allCharacters.push(char);
                    }
                });
            }
        }
        
        let totalPower = 0;
        if (allCharacters.length > 0) {
            allCharacters.forEach(char => {
                const stats = getDisplayStats(char);
                totalPower += stats.hp + stats.mp + stats.atk + stats.def;
            });
            totalPower = Math.floor(totalPower / allCharacters.length);
        }
        
        // „Éú„ÇπÊà¶ÂäõË®àÁÆó
        const basePower = totalPower * BOSS_BASE_MULTIPLIER;
        const bossPower = Math.floor(basePower * BOSS_LEVEL_MULTIPLIERS[level]);
        
        // „É©„É≥„ÉÄ„É†„ÅßÈÉ®ÈñÄÈÅ∏Êäû
        const departmentIds = Object.keys(DEPARTMENT_CONFIG);
        const selectedDeptId = departmentIds[Math.floor(Math.random() * departmentIds.length)];
        
        // ÈÅ∏Êäû„Åï„Çå„ÅüÈÉ®ÈñÄ„ÅÆ„Éë„Éº„ÉÜ„Ç£Êà¶ÂäõË®àÁÆó
        const selectedDept = departments[selectedDeptId];
        const partyMembers = selectedDept ? selectedDept.characters.filter(c => c !== null) : [];
        let partyPower = 0;
        
        partyMembers.forEach(char => {
            if (char) {
                const stats = getDisplayStats(char);
                partyPower += stats.hp + stats.mp + stats.atk + stats.def;
            }
        });
        
        // „Éú„Çπ„Éê„Éà„É´„Éá„Éº„Çø‰øùÂ≠ò
        bossBattleData = {
            boss: {
                level: level,
                name: BOSS_NAMES[level],
                power: bossPower
            },
            party: {
                department: selectedDeptId,
                departmentName: getDepartmentDisplayName(selectedDeptId),
                members: partyMembers,
                power: partyPower
            },
            sacrificedItems: sacrificedItems,
            battleResult: null
        };
        
        saveBossBattleData();
    }
    
    function renderBossInfo() {
        if (!bossBattleData || !bossBattleData.boss) return;
        
        // „Éú„ÇπÊà¶Âäõ„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÂÜçË®àÁÆó
        const allCharacters = [];
        for (let deptId in departments) {
            const dept = departments[deptId];
            if (dept && dept.characters) {
                dept.characters.forEach(char => {
                    if (char) {
                        allCharacters.push(char);
                    }
                });
            }
        }
        
        let totalPower = 0;
        if (allCharacters.length > 0) {
            allCharacters.forEach(char => {
                const stats = getDisplayStats(char);
                totalPower += stats.hp + stats.mp + stats.atk + stats.def;
            });
            totalPower = Math.floor(totalPower / allCharacters.length);
        }
        
        // „Éú„ÇπÊà¶Âäõ„ÇíÊúÄÊñ∞„Éá„Éº„Çø„ÅßÊõ¥Êñ∞
        const basePower = totalPower * BOSS_BASE_MULTIPLIER;
        const updatedBossPower = Math.floor(basePower * BOSS_LEVEL_MULTIPLIERS[bossBattleData.boss.level]);
        bossBattleData.boss.power = updatedBossPower;
        
        const boss = bossBattleData.boss;
        document.getElementById('boss-name').textContent = boss.name;
        document.getElementById('boss-level').textContent = `Lv.${boss.level}`;
        document.getElementById('boss-power').textContent = boss.power.toLocaleString();
        document.getElementById('boss-info').style.display = 'block';
        
        // Êõ¥Êñ∞„Åï„Çå„Åü„Éá„Éº„Çø„Çí‰øùÂ≠ò
        saveBossBattleData();
    }
    
    function renderPartyInfo() {
        if (!bossBattleData || !bossBattleData.party) return;
        
        const party = bossBattleData.party;
        
        // „Éë„Éº„ÉÜ„Ç£Êà¶Âäõ„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÂÜçË®àÁÆó
        const selectedDept = departments[party.department];
        const currentPartyMembers = selectedDept ? selectedDept.characters.filter(c => c !== null) : [];
        let currentPartyPower = 0;
        
        currentPartyMembers.forEach(char => {
            if (char) {
                const stats = getDisplayStats(char);
                currentPartyPower += stats.hp + stats.mp + stats.atk + stats.def;
            }
        });
        
        // „Éë„Éº„ÉÜ„Ç£„Éá„Éº„Çø„ÇíÊúÄÊñ∞„Éá„Éº„Çø„ÅßÊõ¥Êñ∞
        bossBattleData.party.members = currentPartyMembers;
        bossBattleData.party.power = currentPartyPower;
        
        document.getElementById('selected-department').textContent = `üè¢ ${party.departmentName}`;
        
        const membersContainer = document.getElementById('party-members');
        if (currentPartyMembers.length === 0) {
            membersContainer.innerHTML = '<div class="party-member"><div class="party-member-name">No active members</div><div>This department is empty</div></div>';
        } else {
            membersContainer.innerHTML = currentPartyMembers.map(member => {
                const stats = getDisplayStats(member);
                const totalStats = stats.hp + stats.mp + stats.atk + stats.def;
                return `
                    <div class="party-member">
                        <div class="party-member-name">${member.name}</div>
                        <div>${member.jobName} - Lv.${member.level}</div>
                        <div>Power: ${totalStats}</div>
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('party-total-power').textContent = currentPartyPower.toLocaleString();
        document.getElementById('boss-total-power').textContent = bossBattleData.boss.power.toLocaleString();
        document.getElementById('party-info').style.display = 'block';
        
        // Êõ¥Êñ∞„Åï„Çå„Åü„Éá„Éº„Çø„Çí‰øùÂ≠ò
        saveBossBattleData();
    }
    
    function attackBoss() {
        if (!bossBattleData || !bossBattleData.boss || !bossBattleData.party) return;
        
        const victory = bossBattleData.party.power > bossBattleData.boss.power;
        let reward = null;
        
        if (victory) {
            // Â†±ÈÖ¨Ë£ÖÂÇôÁîüÊàê
            reward = generateBossReward(bossBattleData.boss.level);
            if (reward) {
                ownedEquipment.push(reward);
                saveOwnedEquipment();
            }
        }
        
        // Êà¶ÈóòÁµêÊûú‰øùÂ≠ò
        bossBattleData.battleResult = {
            victory: victory,
            reward: reward,
            partyPower: bossBattleData.party.power,
            bossPower: bossBattleData.boss.power
        };
        
        saveBossBattleData();
        
        // UIÊõ¥Êñ∞
        document.getElementById('battle-actions').style.display = 'none';
        renderBattleResult();
        saveAndRender();
    }
    
    function generateBossReward(bossLevel) {
        // ‚òÖ5Ë£ÖÂÇô„ÅÆ„Éâ„É≠„ÉÉ„ÉóÂà§ÂÆö
        const legendaryChance = LEGENDARY_DROP_RATES[bossLevel];
        const isLegendary = Math.random() < legendaryChance;
        
        // ÂØæË±°Ë£ÖÂÇô„ÇíÈÅ∏Êäû
        const targetRarity = isLegendary ? 5 : 4;
        const availableEquipment = EQUIPMENT_DATABASE.filter(eq => eq.rarity === targetRarity);
        
        if (availableEquipment.length === 0) {
            return null;
        }
        
        const selectedEquipment = availableEquipment[Math.floor(Math.random() * availableEquipment.length)];
        const slotType = selectedEquipment.slotType || getEquipmentSlotType(selectedEquipment);
        
        // Êñ∞„Åó„ÅÑË£ÖÂÇô„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
        const newEquipment = {
            instanceId: equipmentIdCounter++,
            id: selectedEquipment.id,
            name: selectedEquipment.name,
            type: slotType || selectedEquipment.type,
            slotType: slotType || selectedEquipment.type,
            rarity: selectedEquipment.rarity,
            statBonus: selectedEquipment.statBonus,
            departmentRestriction: selectedEquipment.departmentRestriction,
            isEquipped: false,
            equippedTo: null
        };
        
        return newEquipment;
    }
    
    function renderBattleResult() {
        if (!bossBattleData || !bossBattleData.battleResult) return;
        
        const result = bossBattleData.battleResult;
        const resultDiv = document.getElementById('battle-result');
        const titleDiv = document.getElementById('result-title');
        const detailsDiv = document.getElementById('result-details');
        const rewardContainer = document.getElementById('reward-container');
        
        if (result.victory) {
            resultDiv.className = 'battle-result victory';
            titleDiv.textContent = 'üéâ VICTORY!';
            detailsDiv.textContent = `Your party (${result.partyPower}) defeated the boss (${result.bossPower})!`;
            
            if (result.reward) {
                const rarityStars = '‚òÖ'.repeat(result.reward.rarity);
                rewardContainer.innerHTML = `
                    <div class="reward-item">
                        <div class="reward-name">üéÅ ${result.reward.name} ${rarityStars}</div>
                        <div>Added to your equipment inventory!</div>
                    </div>
                `;
            } else {
                rewardContainer.innerHTML = '<div>No reward generated.</div>';
            }
        } else {
            resultDiv.className = 'battle-result defeat';
            titleDiv.textContent = 'üíÄ DEFEAT...';
            detailsDiv.textContent = `Your party (${result.partyPower}) was defeated by the boss (${result.bossPower}).`;
            rewardContainer.innerHTML = '<div>No reward this time. Train harder!</div>';
        }
        
        resultDiv.style.display = 'block';
    }
    
    function resetBossBattle() {
        bossBattleData = null;
        saveBossBattleData();
        renderBossBattleInterface();
    }
    
    function saveBossBattleData() {
        localStorage.setItem(BOSS_BATTLE_KEY, JSON.stringify(bossBattleData));
    }
    
    function renderBuffDetails(character, type, buffSummary) {
        const summary = buffSummary || {};
        const baseStats = character.baseStats || { hp: 0, mp: 0, atk: 0, def: 0 };
        const equipmentStats = summary.equipment || { hp: 0, mp: 0, atk: 0, def: 0 };
        const departmentStats = summary.department || { hp: 0, mp: 0, atk: 0, def: 0 };
        const commanderStats = summary.commander || { hp: 0, mp: 0, atk: 0, def: 0 };
        const segment = summary[type] || { hp: 0, mp: 0, atk: 0, def: 0 };
        const statsOrder = ['hp', 'mp', 'atk', 'def'];
        const forceShowAll = type === 'commander';
        
        const referenceStats = (() => {
            switch (type) {
                case 'equipment':
                    return baseStats;
                case 'department':
                    return {
                        hp: baseStats.hp + (equipmentStats.hp || 0),
                        mp: baseStats.mp + (equipmentStats.mp || 0),
                        atk: baseStats.atk + (equipmentStats.atk || 0),
                        def: baseStats.def + (equipmentStats.def || 0)
                    };
                case 'commander':
                    return {
                        hp: baseStats.hp + (equipmentStats.hp || 0) + (departmentStats.hp || 0),
                        mp: baseStats.mp + (equipmentStats.mp || 0) + (departmentStats.mp || 0),
                        atk: baseStats.atk + (equipmentStats.atk || 0) + (departmentStats.atk || 0),
                        def: baseStats.def + (equipmentStats.def || 0) + (departmentStats.def || 0)
                    };
                case 'total':
                    return {
                        hp: baseStats.hp + (equipmentStats.hp || 0) + (departmentStats.hp || 0) + (commanderStats.hp || 0),
                        mp: baseStats.mp + (equipmentStats.mp || 0) + (departmentStats.mp || 0) + (commanderStats.mp || 0),
                        atk: baseStats.atk + (equipmentStats.atk || 0) + (departmentStats.atk || 0) + (commanderStats.atk || 0),
                        def: baseStats.def + (equipmentStats.def || 0) + (departmentStats.def || 0) + (commanderStats.def || 0)
                    };
                default:
                    return baseStats;
            }
        })();
        
        const details = [];
        statsOrder.forEach(stat => {
            const value = segment[stat] || 0;
            if (value !== 0 || forceShowAll) {
                const statName = stat.toUpperCase();
                const baseValue = referenceStats[stat] || 0;
                const percentage = baseValue !== 0 ? Math.round((value / baseValue) * 100) : null;
                const percentageText = percentage !== null ? ` (${percentage}%)` : '';
                const prefix = value >= 0 ? '+' : '';
                details.push(`<div class="buff-item">${statName}: ${prefix}${value}${percentageText}</div>`);
            }
        });
        
        if (!forceShowAll && details.length === 0) {
            return '<div class="buff-none">None</div>';
        }
        
        return details.join('');
    }
    
    function calculateDetailedBuffs(character) {
        if (!character) return null;
        
        const baseStats = { ...character.baseStats };
        const zeroStats = { hp: 0, mp: 0, atk: 0, def: 0 };
        
        if (character.isElder) {
            return {
                equipment: { ...zeroStats },
                commander: { ...zeroStats },
                department: { ...zeroStats },
                total: { ...zeroStats },
                finalStats: { ...baseStats }
            };
        }
        
        const addStats = (a, b) => ({
            hp: (a.hp || 0) + (b.hp || 0),
            mp: (a.mp || 0) + (b.mp || 0),
            atk: (a.atk || 0) + (b.atk || 0),
            def: (a.def || 0) + (b.def || 0)
        });
        
        const equipmentBonus = getEquipmentBonus(character);
        const statsAfterEquipment = addStats(baseStats, equipmentBonus);
        const departmentBonus = getDepartmentBonus(character, statsAfterEquipment);
        const statsAfterDepartment = addStats(statsAfterEquipment, departmentBonus);
        const isCommanderUnit = character.isCommander || character.jobName === 'Commander';
        
        let commanderBonus = { ...zeroStats };
        let statsAfterCommander = { ...statsAfterDepartment };
        
        if (isCommanderUnit) {
            const debuffedStats = applyCommanderDebuff(statsAfterDepartment);
            commanderBonus = {
                hp: debuffedStats.hp - statsAfterDepartment.hp,
                mp: debuffedStats.mp - statsAfterDepartment.mp,
                atk: debuffedStats.atk - statsAfterDepartment.atk,
                def: debuffedStats.def - statsAfterDepartment.def
            };
            statsAfterCommander = debuffedStats;
        } else {
            commanderBonus = getCommanderBonus(character, statsAfterDepartment);
            statsAfterCommander = addStats(statsAfterDepartment, commanderBonus);
        }
        
        const totalBonus = {
            hp: statsAfterCommander.hp - baseStats.hp,
            mp: statsAfterCommander.mp - baseStats.mp,
            atk: statsAfterCommander.atk - baseStats.atk,
            def: statsAfterCommander.def - baseStats.def
        };
        
        return {
            equipment: equipmentBonus,
            commander: commanderBonus,
            department: departmentBonus,
            total: totalBonus,
            finalStats: statsAfterCommander
        };
    }
    
    function getEquipmentBonus(character) {
        const equippedItems = ownedEquipment.filter(eq => eq.isEquipped && eq.equippedTo === character.id);
        const bonus = { hp: 0, mp: 0, atk: 0, def: 0 };
        
        equippedItems.forEach(item => {
            if (item.statBonus) {
                Object.keys(item.statBonus).forEach(stat => {
                    bonus[stat] += item.statBonus[stat];
                });
            }
        });
        
        return bonus;
    }
    
    function getCommanderBonus(character, statsForCalculation = character.baseStats) {
        const department = getCharacterDepartment(character);
        const deptChars = departments[department]?.characters || [];
        const commander = deptChars.find(c => c && (c.isCommander || c.jobName === 'Commander' || c.isElder));
        
        if (!commander || commander.id === character.id) {
            return { hp: 0, mp: 0, atk: 0, def: 0 };
        }
        
        return {
            hp: Math.floor((statsForCalculation.hp || 0) * 0.2),
            mp: Math.floor((statsForCalculation.mp || 0) * 0.2),
            atk: Math.floor((statsForCalculation.atk || 0) * 0.2),
            def: Math.floor((statsForCalculation.def || 0) * 0.2)
        };
    }
    
    function getDepartmentBonus(character, statsForCalculation = character.baseStats) {
        const department = getCharacterDepartment(character);
        const deptConfig = DEPARTMENT_CONFIG[department];
        
        if (!deptConfig?.buff) return { hp: 0, mp: 0, atk: 0, def: 0 };
        
        const bonus = { hp: 0, mp: 0, atk: 0, def: 0 };
        Object.keys(deptConfig.buff).forEach(stat => {
            const baseValue = statsForCalculation[stat] || 0;
            const multiplier = deptConfig.buff[stat] - 1;
            bonus[stat] = Math.floor(baseValue * multiplier);
        });
        
        return bonus;
    }

    // ========== Assignment/Transfer System ==========
    
    function openAssignmentModal(index, isTransfer = false) {
        const sourceDept = currentDepartment;
        const chars = departments[sourceDept].characters;
        const char = chars[index];
        
        if (!char) return;
        if (isTransfer && !isReadyForTransfer(char)) return;
        if (!isTransfer && !isReadyForAssignment(char)) return;
        
        assigningCharacter = char;
        assigningFromIndex = index;
        assigningFromDepartment = sourceDept;
        isTransferMode = isTransfer;
        
        // „É¢„Éº„ÉÄ„É´„Çø„Ç§„Éà„É´Â§âÊõ¥
        document.getElementById('assignment-modal-title').textContent = 
            isTransfer ? 'TRANSFER TO DEPARTMENT' : 'ASSIGN TO DEPARTMENT';
        document.getElementById('dept-select-label').textContent = 
            isTransfer ? 'Ëª¢ËÅ∑ÂÖàÈÉ®ÈñÄ:' : 'ÈÖçÂ±ûÂÖàÈÉ®ÈñÄ:';
        document.getElementById('confirm-assignment-btn').textContent = 
            isTransfer ? '‚úì Ëª¢ËÅ∑„ÇíÁ¢∫ÂÆö' : '‚úì ÈÖçÂ±û„ÇíÁ¢∫ÂÆö';
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÊÉÖÂ†±Ë°®Á§∫
        document.getElementById('assign-char-name').innerText = `${char.name} (${char.jobName})`;
        document.getElementById('assign-char-info').innerText = 
            `Lv.${char.level} | Dept Level: ${char.deptLevelCount} | HP:${char.baseStats.hp} MP:${char.baseStats.mp} ATK:${char.baseStats.atk} DEF:${char.baseStats.def}`;
        
        // Ëª¢ËÅ∑ÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ‰∏äÊòáË°®Á§∫
        if (isTransfer) {
            displayStatBoost(char, sourceDept);
        } else {
            document.getElementById('stat-boost-container').style.display = 'none';
        }
        
        // ÈÉ®ÈñÄ„É™„Çπ„ÉàÁîüÊàê
        const deptSelect = document.getElementById('assign-dept-select');
        deptSelect.innerHTML = '';
        for (let deptId in DEPARTMENT_CONFIG) {
            if (isTransfer) {
                // Ëª¢ËÅ∑ÊôÇ„ÅØÁèæÂú®„ÅÆÈÉ®ÈñÄ‰ª•Â§ñ„ÇíË°®Á§∫
                if (deptId !== sourceDept && !DEPARTMENT_CONFIG[deptId].isTraining) {
                    const option = document.createElement('option');
                    option.value = deptId;
                    option.textContent = DEPARTMENT_CONFIG[deptId].name;
                    deptSelect.appendChild(option);
                }
            } else {
                // ÂàùÂõûÈÖçÂ±ûÊôÇ„ÅØDevelopment Center‰ª•Â§ñ„ÇíË°®Á§∫
                if (!DEPARTMENT_CONFIG[deptId].isTraining) {
                    const option = document.createElement('option');
                    option.value = deptId;
                    option.textContent = DEPARTMENT_CONFIG[deptId].name;
                    deptSelect.appendChild(option);
                }
            }
        }
        
        updateJobSelect();
        document.getElementById('assignment-modal').style.display = 'block';
    }

    function displayStatBoost(char, sourceDeptId) {
        const container = document.getElementById('stat-boost-container');
        const sourceDeptConfig = DEPARTMENT_CONFIG[sourceDeptId];
        
        if (!sourceDeptConfig.buff) {
            container.style.display = 'none';
            return;
        }
        
        const boosts = [];
        const statNames = { hp: 'HP', mp: 'MP', atk: 'ATK', def: 'DEF' };
        
        for (let stat in sourceDeptConfig.buff) {
            const baseStat = char.baseStats[stat];
            const boostedStat = Math.floor(baseStat * sourceDeptConfig.buff[stat]);
            const increase = boostedStat - baseStat;
            boosts.push({
                name: statNames[stat],
                old: baseStat,
                new: boostedStat,
                increase: increase
            });
        }
        
        if (boosts.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.innerHTML = `
            <div class="stat-boost-display">
                <div class="title">üéÅ Ëª¢ËÅ∑„Éú„Éº„Éä„ÇπÔºà${sourceDeptConfig.name}Ôºâ</div>
                ${boosts.map(b => `
                    <div class="stat-boost-item">
                        <span>${b.name}: ${b.old} ‚Üí ${b.new}</span>
                        <span style="color: var(--command-color); font-weight: bold;">+${b.increase}</span>
                    </div>
                `).join('')}
                <div style="margin-top: 8px; font-size: 0.7rem; opacity: 0.7;">
                    ‚Äª Ëª¢ËÅ∑ÊôÇ„Å´Âü∫Á§éÂÄ§„Å´Ê∞∏Á∂öÁöÑ„Å´Âä†ÁÆó„Åï„Çå„Åæ„Åô
                </div>
            </div>
        `;
        container.style.display = 'block';
    }

    function updateJobSelect() {
        const deptId = document.getElementById('assign-dept-select').value;
        const jobSelect = document.getElementById('assign-job-select');
        const dept = departments[deptId];
        const config = DEPARTMENT_CONFIG[deptId];
        
        const occupiedJobs = dept.characters.filter(c => c !== null && !c.isElder).map(c => c.jobName);
        
        jobSelect.innerHTML = '';
        config.jobs.forEach(job => {
            if (!occupiedJobs.includes(job)) {
                const option = document.createElement('option');
                option.value = job;
                option.textContent = job;
                jobSelect.appendChild(option);
            }
        });
        
        if (jobSelect.options.length === 0) {
            jobSelect.innerHTML = '<option value="">Á©∫„Åç„Éù„Ç∏„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</option>';
        }
    }

    function confirmAssignment() {
        const targetDeptId = document.getElementById('assign-dept-select').value;
        const newJob = document.getElementById('assign-job-select').value;
        
        if (!newJob || newJob === '' || newJob === 'Á©∫„Åç„Éù„Ç∏„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì') {
            alert('ÈÖçÂ±ûÂèØËÉΩ„Å™ËÅ∑Âãô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            return;
        }
        
        const targetDept = departments[targetDeptId];
        let targetIndex = -1;
        
        // Commander„Å∏„ÅÆËª¢ËÅ∑„ÅÆÂ†¥Âêà
        if (newJob === 'Commander') {
            targetIndex = 4;
            if (targetDept.characters[4] !== null) {
                alert('Commander„Çπ„É≠„ÉÉ„Éà„ÅØÊó¢„Å´Âüã„Åæ„Å£„Å¶„ÅÑ„Åæ„Åô');
                return;
            }
        } else {
            // ÈÄöÂ∏∏„Çπ„É≠„ÉÉ„ÉàÔºà0-3Ôºâ„Å∏„ÅÆÈÖçÂ±û/Ëª¢ËÅ∑
            for (let i = 0; i < 4; i++) {
                if (targetDept.characters[i] === null) {
                    targetIndex = i;
                    break;
                }
            }
            if (targetIndex === -1) {
                alert('ÈÖçÂ±ûÂÖà„Å´Á©∫„Åç„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
        }
        
        // Ëª¢ËÅ∑Âá¶ÁêÜ
        if (isTransferMode) {
            applyDepartmentBuffToBaseStats(assigningCharacter, assigningFromDepartment);
            incrementTransferCount();
            addSystemLog('üîÑ', `${assigningCharacter.name} „Åå ${DEPARTMENT_CONFIG[assigningFromDepartment].name} „Åã„Çâ ${DEPARTMENT_CONFIG[targetDeptId].name} „Å´Ëª¢ËÅ∑„Åó„Åæ„Åó„Åü`, null);
        }
        
        // ËÅ∑Ê•≠Â§âÊõ¥
        assigningCharacter.jobName = newJob;
        assigningCharacter.currentDepartment = targetDeptId;
        assigningCharacter.deptLevelCount = 0;
        
        // ÁßªÂãïÂá¶ÁêÜ
        targetDept.characters[targetIndex] = assigningCharacter;
        departments[assigningFromDepartment].characters[assigningFromIndex] = null;
        
        saveDepartments();
        closeAssignmentModal();
        saveAndRender();
        
        const actionText = isTransferMode ? 'Ëª¢ËÅ∑' : 'ÈÖçÂ±û';
        alert(`${assigningCharacter.name}„Çí${DEPARTMENT_CONFIG[targetDeptId].name}„ÅÆ${newJob}„Å´${actionText}„Åó„Åæ„Åó„ÅüÔºÅ`);
    }

    function applyDepartmentBuffToBaseStats(character, sourceDeptId) {
        const sourceDeptConfig = DEPARTMENT_CONFIG[sourceDeptId];
        if (!sourceDeptConfig.buff) return;
        
        for (let stat in sourceDeptConfig.buff) {
            const oldValue = character.baseStats[stat];
            const newValue = Math.floor(oldValue * sourceDeptConfig.buff[stat]);
            character.baseStats[stat] = newValue;
            
            const increase = newValue - oldValue;
            if (increase > 0) {
                addSystemLog('üìà', `${character.name} „ÅÆ ${stat.toUpperCase()} „Åå ${oldValue} ‚Üí ${newValue} „Å´Ê∞∏Á∂ö‰∏äÊòá`, null);
            }
        }
    }

    function closeAssignmentModal() {
        document.getElementById('assignment-modal').style.display = 'none';
        assigningCharacter = null;
        assigningFromIndex = null;
        assigningFromDepartment = null;
        isTransferMode = false;
    }

    // ========== Party Management Modal ==========
    
    function openPartyManagement() {
        document.getElementById('party-modal').style.display = 'block';
        renderDepartmentSelector('modal-dept-selector');
        renderJobButtons();
        renderReserveArea();
    }

    function closePartyManagement() {
        document.getElementById('party-modal').style.display = 'none';
        document.getElementById('applicant-area').innerHTML = '';
    }

    let currentApplicants = [];
    let recruitingJob = '';

    function renderJobButtons() {
        const area = document.getElementById('job-select-area');
        const config = DEPARTMENT_CONFIG[currentDepartment];
        const occupiedJobs = getOccupiedJobs();

        area.innerHTML = config.jobs.map(job => {
            const isTrainingJob = (job === 'Fresh Graduate' || job === 'Career Hire');
            const isOccupied = !isTrainingJob && occupiedJobs.includes(job);
            return `<button class="job-btn ${isOccupied ? 'disabled' : ''}" 
                            onclick="${isOccupied ? '' : `startRecruit('${job}')`}">
                            ${job}${isOccupied ? ' (ÈÖçÂ±ûÊ∏à)' : ''}
                            </button>`;
        }).join('');
    }

    function startRecruit(jobName) {
        recruitingJob = jobName;
        currentApplicants = [];
        
        for (let i = 0; i < 3; i++) {
            currentApplicants.push(generateApplicant(jobName));
        }
        
        renderApplicants();
    }

    function renderApplicants() {
        const area = document.getElementById('applicant-area');
        area.innerHTML = `
            <div style="margin: 15px 0; font-size: 0.85rem; color: var(--primary-color);">
                ÂøúÂãüËÄÖ„Åã„Çâ1Âêç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà3Âêç‰∏≠1ÂêçÔºâ
            </div>
            <div class="applicant-list">
                ${currentApplicants.map((app, i) => `
                    <div class="applicant-card" onclick="hireApplicant(${i})">
                        <div class="applicant-name">${app.name}</div>
                        <div class="applicant-job">${app.jobName}</div>
                        <div class="applicant-stats">
                            <div>HP: ${app.baseStats.hp}</div>
                            <div>MP: ${app.baseStats.mp}</div>
                            <div>ATK: ${app.baseStats.atk}</div>
                            <div>DEF: ${app.baseStats.def}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function hireApplicant(index) {
        const applicant = currentApplicants[index];
        
        const trainingChars = departments.training.characters;
        let targetIndex = -1;
        for (let i = 0; i < 4; i++) {
            if (trainingChars[i] === null) {
                targetIndex = i;
                break;
            }
        }
        
        if (targetIndex === -1) {
            alert('Development Center„Å´Á©∫„Åç„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            return;
        }
        
        trainingChars[targetIndex] = applicant;
        saveDepartments();
        saveAndRender();
        
        renderJobButtons();
        currentApplicants = [];
        document.getElementById('applicant-area').innerHTML = '<div style="color: var(--command-color); margin-top: 15px;">‚úì Êé°Áî®ÂÆå‰∫ÜÔºÅDevelopment Center„Å´ÈÖçÂ±û„Åï„Çå„Åæ„Åó„Åü</div>';
        
        setTimeout(() => {
            document.getElementById('applicant-area').innerHTML = '';
        }, 2000);
    }

    function renderReserveArea() {
        const area = document.getElementById('reserve-area');
        document.getElementById('reserve-count').innerText = reserveCharacters.length;
        
        if (reserveCharacters.length === 0) {
            area.innerHTML = '<div style="opacity: 0.5; font-size: 0.75rem;">‰øùÁïô‰∏≠„ÅÆ„É°„É≥„Éê„Éº„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>';
            return;
        }
        
        area.innerHTML = reserveCharacters.map((char, i) => `
            <div class="reserve-card" onclick="showReserveMenu(${i})">
                <span class="name">${char.name}</span>
                <span class="job">${char.jobName}</span>
                ${isReadyForAssignment(char) ? '<span style="color: var(--command-color); margin-left: 8px;">‚úì</span>' : ''}
            </div>
        `).join('');
    }

    function showReserveMenu(index) {
        const char = reserveCharacters[index];
        const action = prompt(`${char.name}„ÅÆÂá¶ÁêÜ„ÇíÈÅ∏Êäû\n1: ÁèæÂú®„ÅÆÈÉ®ÈñÄ„Å´Âæ©Â∏∞\n2: ÂÆåÂÖ®„Å´Ëß£Èõá`);
        
        if (action === '1') {
            const chars = getCurrentCharacters();
            
            let targetIndex = -1;
            for (let i = 0; i < 4; i++) {
                if (chars[i] === null) {
                    targetIndex = i;
                    break;
                }
            }
            if (targetIndex === -1) {
                alert('ÁèæÂú®„ÅÆÈÉ®ÈñÄ„Å´Á©∫„Åç„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            chars[targetIndex] = char;
            reserveCharacters.splice(index, 1);
        } else if (action === '2') {
            if (confirm(`${char.name}„ÇíÂÆåÂÖ®„Å´Ëß£Èõá„Åó„Åæ„Åô„ÅãÔºü`)) {
                reserveCharacters.splice(index, 1);
            }
        }
        
        saveDepartments();
        saveAndRender();
        renderReserveArea();
        if (document.getElementById('party-modal').style.display === 'block') {
            renderJobButtons();
        }
    }

    // ========== Task System ==========
    
    function saveAndRender() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        localStorage.setItem(TEMP_KEY, JSON.stringify(templates));
        if (currentMode === 'map') {
            render();
            renderBattleView();
            renderDepartmentSelector('dept-selector');
            renderCharacters();
            renderSystemLog();
            updateTransferCounter();
        } else {
            renderTemplateEditor();
        }
    }

    function addTask(pId) {
        const input = document.getElementById(pId ? `input-${pId}` : 'main-input');
        if (!input || !input.value) return;

        const newId = Date.now();
        const newTask = { 
            id: newId, parentId: pId, text: input.value, 
            workDone: false, reportDone: false, comment: "", 
            priority: 'normal', type: 'blitz', isCollapsed: false
        };

        if (pId) {
            const dEl = document.getElementById(`date-${pId}`), 
                  pEl = document.getElementById(`priority-${pId}`), 
                  tEl = document.getElementById(`type-${pId}`);
            if (dEl && dEl.value) newTask.deadline = dEl.value;
            if (pEl) newTask.priority = pEl.value;
            if (tEl) newTask.type = tEl.value;
            
            const parent = tasks.find(x => x.id === pId);
            if (parent) parent.isCollapsed = false;
        }

        tasks.push(newTask);
        input.value = "";
        saveAndRender();

        setTimeout(() => {
            const depth = getTaskDepth(newId);
            if (depth < 3) {
                const nextInput = document.getElementById(`input-${newId}`);
                if (nextInput) nextInput.focus();
            } else {
                if (input) input.focus();
            }
        }, 10);
    }

    function enableFocus(id) {
        tasks.forEach(t => {
            if (t.parentId === null) {
                t.isCollapsed = (t.id !== id);
            }
        });
        saveAndRender();
    }

    function toggleCollapse(id) {
        const t = tasks.find(x => x.id === id);
        if (t) {
            t.isCollapsed = !t.isCollapsed;
            saveAndRender();
        }
    }

    function handleGlobalInputKey(e, pId) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            addTask(pId);
        }
    }

    function render() {
        const container = document.getElementById('task-container');
        container.innerHTML = `
            <div style="background: var(--panel-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                <input type="text" id="main-input" style="width:80%;" placeholder="DEPLOY MAIN MISSION..." onkeydown="handleGlobalInputKey(event, null)">
                <button class="btn-utility" style="background:var(--main-quest-color)" onclick="addTask(null)">DEPLOY</button>
            </div>`;
        tasks.filter(t => t.parentId === null && !t.reportDone).forEach(t => container.appendChild(createTaskElement(t, 0)));
    }

    function createTaskElement(t, depth) {
        const div = document.createElement('div');
        div.className = "task-item";
        
        const children = tasks.filter(x => x.parentId === t.id && !x.reportDone);
        
        let subInputHtml = "";
        let childrenHtml = "";

        const controls = (depth === 0) 
            ? `<button class="btn-toggle" onclick="toggleCollapse(${t.id})">${t.isCollapsed ? '+' : '-'}</button>
               <button class="btn-focus" onclick="enableFocus(${t.id})">FOCUS</button>` 
            : "";

        if (!t.isCollapsed) {
            if (depth < 3) {
                const isSection = (depth === 1), isSub = (depth === 2);
                const extra = isSub ? `<input type="date" id="date-${t.id}"><select id="type-${t.id}"><option value="blitz">‚ö° Blitz</option><option value="steady">üìä Steady</option></select><select id="priority-${t.id}"><option value="normal">Normal</option><option value="emergency">EMERGENCY</option></select>` : "";
                const tempImport = isSection && templates.length > 0 ? `<select onchange="importTemplate(${t.id}, this.value); this.value='';"><option value="">IMPORT TEMP</option>${templates.map((temp, i) => `<option value="${i}">${temp.name}</option>`).join('')}</select>` : "";
                subInputHtml = `<div class="sub-input-area"><input type="text" id="input-${t.id}" placeholder="ADD ${labels[depth+1].toUpperCase()}..." style="flex:1;" onkeydown="handleGlobalInputKey(event, ${t.id})"><button class="btn-utility" onclick="addTask(${t.id})">+</button>${extra}${tempImport}</div>`;
            }
            const childrenWrapper = document.createElement('div');
            childrenWrapper.className = "indent";
            children.sort((a,b) => (a.deadline||'9999-12-31').localeCompare(b.deadline||'9999-12-31')).forEach(c => childrenWrapper.appendChild(createTaskElement(c, depth+1)));
            childrenHtml = childrenWrapper.outerHTML;
        } else {
            subInputHtml = `<span class="collapsed-hint">(${children.length} tasks hidden)</span>`;
        }

        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
                ${controls}
                <span class="tier-label label-${depth}">${labels[depth]}</span>
                ${depth===3?`<span class="type-tag type-${t.type}">${t.type==='blitz'?'‚ö°':'üìä'}</span>`:''}
                <span class="editable-text" onclick="enableEdit(${t.id}, this)">${t.text}</span>
                ${depth===3?`<input type="date" value="${t.deadline||''}" class="deadline-badge" onchange="updateDeadline(${t.id}, this.value)">`:''}
                <button style="background:none; border:none; color:var(--danger-color); cursor:pointer;" onclick="deleteTask(${t.id})">&times;</button>
            </div>${subInputHtml}${childrenHtml}`;

        return div;
    }

    function renderBattleView() {
        const listBlitz = document.getElementById('list-blitz'), listSteady = document.getElementById('list-steady');
        listBlitz.innerHTML = ""; listSteady.innerHTML = "";
        let active = tasks.filter(t => !t.reportDone && areChildrenReported(t.id) && getTaskDepth(t.id) === 3);
        active.sort((a,b) => (a.deadline||'9999-12-31').localeCompare(b.deadline||'9999-12-31'));
        
        active.forEach(t => {
            const subQuest = tasks.find(x => x.id === t.parentId) || {};
            const section = tasks.find(x => x.id === subQuest.parentId) || {};
            const mainQuest = tasks.find(x => x.id === section.parentId) || {};
            const container = (t.type === 'blitz') ? listBlitz : listSteady;

            const div = document.createElement('div');
            div.className = `battle-item ${t.workDone?'work-done':''} priority-${t.priority}`;
            div.innerHTML = `
                <div class="breadcrumb">
                    <b style="color:var(--main-quest-color)">${mainQuest.text || '???'}</b> > 
                    <span>${section.text || '???'}</span> > 
                    <b style="color:var(--sub-quest-color)">${subQuest.text || '???'}</b>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.6rem; opacity:0.7;">
                    <span style="color:${t.priority==='emergency'?'var(--danger-color)':'inherit'}; font-weight:bold;">${t.priority.toUpperCase()}</span>
                    <span>‚è∞ ${t.deadline||'NO DATE'}</span>
                </div>
                <div style="font-weight:bold; margin-top:4px; font-size:0.9rem;">${t.text}</div>
                <div class="battle-btn-group">
                    ${!t.workDone ? `<button class="btn-action btn-quick" onclick="quickFinish(${t.id})">‚ö° QUICK</button><button class="btn-action btn-main" style="background:var(--work-done-color); color:white;" onclick="completeWork(${t.id})">‚úì DONE</button>` 
                    : `<input type="text" style="width:100%; margin-top:8px;" placeholder="LOG..." onchange="tasks.find(x=>x.id===${t.id}).comment=this.value"><button class="btn-action btn-main" style="background:var(--report-done-color); color:white; width:100%;" onclick="completeReport(${t.id})">‚úì FINALIZE</button>`}
                </div>`;
            container.appendChild(div);
        });
        document.getElementById('count-blitz').innerText = active.filter(t => t.type==='blitz').length;
        document.getElementById('count-steady').innerText = active.filter(t => t.type==='steady').length;
    }

    function toggleMode() {
        currentMode = (currentMode === 'map') ? 'template' : 'map';
        document.getElementById('world-map').style.display = (currentMode === 'map') ? 'block' : 'none';
        document.getElementById('template-editor').style.display = (currentMode === 'template') ? 'block' : 'none';
        document.getElementById('battle-view').style.display = (currentMode === 'map') ? 'block' : 'none';
        document.getElementById('character-panel').style.display = (currentMode === 'map') ? 'block' : 'none';
        document.getElementById('mode-btn').innerText = (currentMode === 'map') ? 'TEMPLATE MODE' : 'MAP MODE';
        document.getElementById('main-container').style.gridTemplateColumns = (currentMode === 'map') ? '1fr 450px 280px' : '1fr';
        saveAndRender();
    }

    function quickFinish(id) {
        const t = tasks.find(x => x.id === id);
        t.workDone = true; 
        t.reportDone = true; 
        t.completedAt = new Date().toISOString();
        
        // Êñ∞Ê©üËÉΩÔºöÈÄ±Áï™Âè∑„Å®TierÊÉÖÂ†±„ÇíÂÆâÂÖ®„Å´Ë®òÈå≤ (v0.25.17)
        if (getTaskDepth(t.id) === 3) { // Command„É¨„Éô„É´„ÅÆ„Åø
            try {
                t.weekCompleted = safeGetWeekString(new Date());
                const hierarchy = extractTierHierarchy(t.id);
                t.mainQuestText = hierarchy.tier0 || '';
                t.sectionText = hierarchy.tier1 || '';
                // Êó¢Â≠ò„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÄÅÊÆµÈöéÁöÑ„Å´ËøΩÂä†
            } catch (error) {
                console.error('Safe complete error in quickFinish:', error);
                // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇÂü∫Êú¨Ê©üËÉΩ„ÅØÂãï‰Ωú„Åï„Åõ„Çã
            }
        }
        
        processLevelUp();
        dropEquipment();
        
        checkParentReportStatus(t.parentId); 
        saveAndRender();
    }

    function completeWork(id) { 
        tasks.find(t => t.id === id).workDone = true; 
        
        processLevelUp();
        dropEquipment();
        
        saveAndRender(); 
    }

    function completeReport(id) {
        const t = tasks.find(x => x.id === id);
        t.reportDone = true; 
        t.completedAt = new Date().toISOString();
        
        // Êñ∞Ê©üËÉΩÔºöÈÄ±Áï™Âè∑„Å®TierÊÉÖÂ†±„ÇíÂÆâÂÖ®„Å´Ë®òÈå≤ (v0.25.17)
        if (getTaskDepth(t.id) === 3) { // Command„É¨„Éô„É´„ÅÆ„Åø
            try {
                t.weekCompleted = safeGetWeekString(new Date());
                const hierarchy = extractTierHierarchy(t.id);
                t.mainQuestText = hierarchy.tier0 || '';
                t.sectionText = hierarchy.tier1 || '';
                // Êó¢Â≠ò„Éá„Éº„Çø„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÄÅÊÆµÈöéÁöÑ„Å´ËøΩÂä†
            } catch (error) {
                console.error('Safe complete error in completeReport:', error);
                // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇÂü∫Êú¨Ê©üËÉΩ„ÅØÂãï‰Ωú„Åï„Åõ„Çã
            }
        }
        
        checkParentReportStatus(t.parentId); 
        saveAndRender();
    }

    function checkParentReportStatus(pId) {
        if (!pId) return;
        const siblings = tasks.filter(t => t.parentId === pId);
        if (siblings.length > 0 && siblings.every(c => c.reportDone)) {
            const p = tasks.find(t => t.id === pId);
            if (p) { p.reportDone = true; p.completedAt = new Date().toISOString(); checkParentReportStatus(p.parentId); }
        }
    }

    function areChildrenReported(pId) { 
        const c = tasks.filter(x=>x.parentId===pId); 
        return c.length===0?true:c.every(x=>x.reportDone && areChildrenReported(x.id)); 
    }

    function getTaskDepth(id) { 
        let d=0, c=tasks.find(x=>x.id===id); 
        while(c&&c.parentId){d++; c=tasks.find(x=>x.id===c.parentId);} 
        return d; 
    }

    // ========== Achievement Logs System v0.25.17 ==========
    
    function extractTierHierarchy(taskId) {
        const hierarchy = { tier0: '', tier1: '', tier2: '' };
        
        try {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return hierarchy;
            
            // ÁèæÂú®„ÅÆ„Çø„Çπ„ÇØ„Åã„ÇâË¶™„ÇíËæø„Çã
            const path = [];
            let current = task;
            
            while (current) {
                path.unshift(current); // ÈÖçÂàó„ÅÆÂÖàÈ†≠„Å´ËøΩÂä†
                if (current.parentId) {
                    current = tasks.find(t => t.id === current.parentId);
                } else {
                    current = null;
                }
            }
            
            // Ê∑±Â∫¶„Å´Âü∫„Å•„ÅÑ„Å¶Tier„ÇíÂâ≤„ÇäÂΩì„Å¶
            if (path.length >= 1) hierarchy.tier0 = path[0].text; // Main Quest
            if (path.length >= 2) hierarchy.tier1 = path[1].text; // Section
            if (path.length >= 3) hierarchy.tier2 = path[2].text; // Command
            
        } catch (error) {
            console.error('Error extracting tier hierarchy:', error);
        }
        
        return hierarchy;
    }

    function safeGetWeekString(date) {
        try {
            if (!date) return '';
            const dateObj = new Date(date);
            if (isNaN(dateObj.getTime())) return '';
            
            // ÂÆâÂÖ®„Å™Êó•‰ªòÂá¶ÁêÜ
            const year = dateObj.getFullYear();
            const startOfYear = new Date(year, 0, 1);
            const dayOfYear = Math.floor((dateObj - startOfYear) / (1000 * 60 * 60 * 24));
            const weekNumber = Math.ceil((dayOfYear + startOfYear.getDay()) / 7);
            
            return `${year}-W${String(weekNumber).padStart(2, '0')}`;
        } catch (error) {
            console.error('Week calculation error:', error);
            return '';
        }
    }

    function getCompletedCommands() {
        return tasks.filter(t => 
            t.reportDone && 
            getTaskDepth(t.id) === 3 && 
            !t.deletedAt // ÂâäÈô§„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÇÇ„ÅÆ„ÅÆ„Åø
        );
    }

    // Achievement LogsÁî®„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
    function updateTaskComment(taskId, newComment) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.comment = newComment;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        }
    }

    function deleteCompletedTask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            // Ë´ñÁêÜÂâäÈô§
            task.deletedAt = new Date().toISOString();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        }
    }

    function enableEdit(id, el) { 
        const t = tasks.find(x=>x.id===id); 
        el.onclick=null;
        el.innerHTML = `<input type="text" class="edit-input" value="${t.text}" onkeydown="if(event.key==='Enter') finishEdit(${id}, this.value)">`;
        el.querySelector('input').focus();
    }

    function finishEdit(id, txt) { 
        if(txt) tasks.find(x=>x.id===id).text=txt; 
        saveAndRender(); 
    }

    function updateDeadline(id, val) { 
        tasks.find(x=>x.id===id).deadline=val; 
        saveAndRender(); 
    }

    function deleteTask(id) { 
        if(confirm("DELETE?")) { 
            tasks=tasks.filter(x=>x.id!==id && x.parentId!==id); 
            saveAndRender(); 
        } 
    }

    function exportData() { 
        const blob=new Blob([JSON.stringify({tasks,templates,departments,reserveCharacters,systemLogs,weeklyTransferData,ownedEquipment,bossBattleData})],{type:'application/json'}); 
        const a=document.createElement('a'); 
        a.href=URL.createObjectURL(blob); 
        a.download='QuestRoot_v25.json'; 
        a.click(); 
    }

    function importData(e) { 
        const r=new FileReader(); 
        r.onload=(ev)=>{ 
            const d=JSON.parse(ev.target.result); 
            tasks=d.tasks||[]; 
            templates=d.templates||[]; 
            departments=d.departments||{}; 
            reserveCharacters=d.reserveCharacters||[];
            systemLogs=d.systemLogs||[];
            weeklyTransferData=d.weeklyTransferData||initWeeklyTransferData();
            ownedEquipment=d.ownedEquipment||[];
            bossBattleData=d.bossBattleData||null;
            initDepartments(); 
            normalizeOwnedEquipmentData();
            saveAndRender(); 
        }; 
        r.readAsText(e.target.files[0]); 
    }

    function clearAllData() { 
        if(confirm("WIPE ALL?")) { 
            tasks=[]; 
            templates=[]; 
            departments={}; 
            reserveCharacters=[];
            systemLogs=[];
            weeklyTransferData=initWeeklyTransferData();
            ownedEquipment=[];
            bossBattleData=null;
            initDepartments(); 
            saveAndRender(); 
        } 
    }

    function openArchiveTab() {
        const completedCommands = getCompletedCommands();
        
        if (completedCommands.length === 0) {
            const win = window.open("", "_blank");
            win.document.write(`
                <html>
                <head>
                    <title>QuestRoot Achievement Logs</title>
                    <style>
                        body { 
                            font-family: 'Inter', sans-serif; 
                            background: #0f172a; 
                            color: #f1f5f9; 
                            margin: 0; 
                            padding: 20px; 
                            text-align: center;
                        }
                    </style>
                </head>
                <body>
                    <h1>üìã Achievement Logs</h1>
                    <p>No completed commands found.</p>
                </body>
                </html>
            `);
            return;
        }

        // Êó¢Â≠ò„Éá„Éº„Çø„Å´TierÊÉÖÂ†±„ÇíË£úÂÆå
        updateExistingCompletedTasks();
        
        const win = window.open("", "_blank");
        win.document.write(generateAchievementLogsHTML(completedCommands));
    }

    function updateExistingCompletedTasks() {
        let updated = false;
        
        getCompletedCommands().forEach(task => {
            // ÈÄ±Áï™Âè∑„Åå„Å™„ÅÑÂ†¥Âêà„ÅØË£úÂÆå
            if (!task.weekCompleted && task.completedAt) {
                task.weekCompleted = safeGetWeekString(task.completedAt);
                updated = true;
            }
            
            // TierÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØË£úÂÆå
            if (!task.mainQuestText || !task.sectionText) {
                const hierarchy = extractTierHierarchy(task.id);
                task.mainQuestText = hierarchy.tier0 || '';
                task.sectionText = hierarchy.tier1 || '';
                updated = true;
            }
        });
        
        if (updated) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        }
    }

    function generateAchievementLogsHTML(completedCommands) {
        // ÂÆå‰∫ÜÊó•ÊôÇ„ÅßÈôçÈ†Ü„ÇΩ„Éº„ÉàÔºàÊúÄÊñ∞„Åå‰∏äÔºâ
        const sortedCommands = [...completedCommands].sort((a, b) => {
            const dateA = new Date(a.completedAt || 0);
            const dateB = new Date(b.completedAt || 0);
            return dateB - dateA;
        });

        // „Éï„Ç£„É´„Çø„ÉºÁî®„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥ÁîüÊàê
        const tier0Options = [...new Set(sortedCommands.map(t => t.mainQuestText).filter(Boolean))].sort();
        const weekOptions = [...new Set(sortedCommands.map(t => t.weekCompleted).filter(Boolean))].sort().reverse();

        return \`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>QuestRoot Achievement Logs</title>
                <style>
                    :root {
                        --bg-color: #0f172a;
                        --panel-bg: #1e293b;
                        --border-color: #334155;
                        --text-color: #f1f5f9;
                        --primary-color: #38bdf8;
                        --success-color: #10b981;
                        --danger-color: #ef4444;
                        --warning-color: #f59e0b;
                    }
                    
                    body { 
                        font-family: 'Inter', sans-serif; 
                        background: var(--bg-color); 
                        color: var(--text-color); 
                        margin: 0; 
                        padding: 20px; 
                        line-height: 1.5;
                    }
                    
                    .container { 
                        max-width: 1600px; 
                        margin: 0 auto; 
                    }
                    
                    h1 { 
                        text-align: center; 
                        color: var(--primary-color); 
                        margin-bottom: 30px; 
                    }
                    
                    .filter-section {
                        background: var(--panel-bg);
                        padding: 15px;
                        border-radius: 8px;
                        border: 1px solid var(--border-color);
                        margin-bottom: 20px;
                        display: flex;
                        gap: 15px;
                        align-items: center;
                        flex-wrap: wrap;
                    }
                    
                    .filter-section label {
                        font-weight: bold;
                        color: var(--primary-color);
                    }
                    
                    .filter-section select {
                        background: var(--bg-color);
                        color: var(--text-color);
                        border: 1px solid var(--border-color);
                        border-radius: 4px;
                        padding: 8px 12px;
                        font-size: 14px;
                    }
                    
                    .logs-table {
                        width: 100%;
                        border-collapse: collapse;
                        background: var(--panel-bg);
                        border-radius: 8px;
                        overflow: hidden;
                        border: 1px solid var(--border-color);
                    }
                    
                    .logs-table th {
                        background: var(--bg-color);
                        color: var(--primary-color);
                        padding: 12px 8px;
                        text-align: left;
                        font-weight: bold;
                        border-bottom: 2px solid var(--border-color);
                        position: sticky;
                        top: 0;
                        z-index: 10;
                    }
                    
                    .logs-table td {
                        padding: 10px 8px;
                        border-bottom: 1px solid var(--border-color);
                        vertical-align: top;
                    }
                    
                    .logs-table tbody tr:hover {
                        background: rgba(56, 189, 248, 0.1);
                    }
                    
                    .logs-table tbody tr:nth-child(even) {
                        background: rgba(30, 41, 59, 0.5);
                    }
                    
                    .command-text {
                        font-weight: bold;
                        color: var(--success-color);
                    }
                    
                    .tier-text {
                        font-size: 0.9em;
                        opacity: 0.8;
                    }
                    
                    .comment-cell {
                        max-width: 200px;
                        word-wrap: break-word;
                    }
                    
                    .comment-text {
                        font-style: italic;
                        opacity: 0.9;
                    }
                    
                    .comment-placeholder {
                        opacity: 0.5;
                        font-style: italic;
                    }
                    
                    .action-buttons {
                        display: flex;
                        gap: 5px;
                    }
                    
                    .btn {
                        padding: 4px 8px;
                        border: none;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: opacity 0.2s;
                    }
                    
                    .btn:hover {
                        opacity: 0.8;
                    }
                    
                    .btn-edit {
                        background: var(--warning-color);
                        color: white;
                    }
                    
                    .btn-delete {
                        background: var(--danger-color);
                        color: white;
                    }
                    
                    .no-results {
                        text-align: center;
                        padding: 40px;
                        color: var(--text-color);
                        opacity: 0.7;
                    }

                    @media (max-width: 1200px) {
                        .logs-table {
                            font-size: 14px;
                        }
                        .logs-table th, .logs-table td {
                            padding: 8px 4px;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üìã QuestRoot Achievement Logs</h1>
                    
                    <div class="filter-section">
                        <label>Filters:</label>
                        <select id="tier0-filter" onchange="applyFilters()">
                            <option value="">Filter by Tier 0</option>
                            \${tier0Options.map(option => \`<option value="\${escapeHtml(option)}">\${escapeHtml(option)}</option>\`).join('')}
                        </select>
                        <select id="week-filter" onchange="applyFilters()">
                            <option value="">Filter by Week</option>
                            \${weekOptions.map(week => \`<option value="\${escapeHtml(week)}">\${getWeekDisplayText(week)}</option>\`).join('')}
                        </select>
                        <button onclick="clearFilters()" style="background: var(--primary-color); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Clear Filters</button>
                    </div>
                    
                    <div id="table-container">
                        \${generateTableHTML(sortedCommands)}
                    </div>
                </div>

                <script>
                    let allCommands = \${JSON.stringify(sortedCommands)};
                    
                    function escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text || '';
                        return div.innerHTML;
                    }
                    
                    function getWeekDisplayText(week) {
                        if (!week) return 'Unknown Week';
                        const parts = week.split('-W');
                        if (parts.length === 2) {
                            return \`\${parts[0]} Week \${parts[1]}\`;
                        }
                        return week;
                    }
                    
                    function applyFilters() {
                        const tier0Filter = document.getElementById('tier0-filter').value;
                        const weekFilter = document.getElementById('week-filter').value;
                        
                        let filtered = allCommands;
                        
                        if (tier0Filter) {
                            filtered = filtered.filter(cmd => cmd.mainQuestText === tier0Filter);
                        }
                        
                        if (weekFilter) {
                            filtered = filtered.filter(cmd => cmd.weekCompleted === weekFilter);
                        }
                        
                        document.getElementById('table-container').innerHTML = generateTableHTML(filtered);
                    }
                    
                    function clearFilters() {
                        document.getElementById('tier0-filter').value = '';
                        document.getElementById('week-filter').value = '';
                        applyFilters();
                    }
                    
                    function generateTableHTML(commands) {
                        if (commands.length === 0) {
                            return '<div class="no-results">No commands match the current filters.</div>';
                        }
                        
                        return \`
                            <table class="logs-table">
                                <thead>
                                    <tr>
                                        <th style="width: 60px;">No</th>
                                        <th style="width: 150px;">Completed Date</th>
                                        <th style="width: 250px;">Command Content</th>
                                        <th style="width: 180px;">Tier 0</th>
                                        <th style="width: 180px;">Tier 1</th>
                                        <th style="width: 180px;">Tier 2</th>
                                        <th style="width: 200px;">Comment</th>
                                        <th style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    \${commands.map((cmd, index) => generateRowHTML(cmd, index + 1)).join('')}
                                </tbody>
                            </table>
                        \`;
                    }
                    
                    function generateRowHTML(cmd, index) {
                        const completedAt = cmd.completedAt ? new Date(cmd.completedAt) : null;
                        const timeString = completedAt 
                            ? completedAt.toLocaleString('en-US', { 
                                year: 'numeric', 
                                month: '2-digit', 
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                              })
                            : 'Unknown time';
                        
                        const hierarchy = {
                            tier0: cmd.mainQuestText || '',
                            tier1: cmd.sectionText || '',
                            tier2: cmd.text || ''
                        };
                        
                        const comment = cmd.comment || '';
                        
                        return \`
                            <tr>
                                <td>\${index}</td>
                                <td>\${escapeHtml(timeString)}</td>
                                <td><div class="command-text">\${escapeHtml(hierarchy.tier2)}</div></td>
                                <td><div class="tier-text">\${escapeHtml(hierarchy.tier0)}</div></td>
                                <td><div class="tier-text">\${escapeHtml(hierarchy.tier1)}</div></td>
                                <td><div class="tier-text">\${escapeHtml(hierarchy.tier2)}</div></td>
                                <td class="comment-cell">
                                    <div id="comment-display-\${cmd.id}">
                                        \${comment ? \`<div class="comment-text">\${escapeHtml(comment)}</div>\` : \`<div class="comment-placeholder">No comment</div>\`}
                                    </div>
                                    <div id="comment-edit-\${cmd.id}" style="display: none;">
                                        <textarea id="comment-textarea-\${cmd.id}" style="width: 100%; height: 60px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 3px;" maxlength="120">\${escapeHtml(comment)}</textarea>
                                        <div style="margin-top: 5px;">
                                            <button class="btn btn-edit" onclick="saveComment(\${cmd.id})">Save</button>
                                            <button class="btn" onclick="cancelEdit(\${cmd.id})" style="background: #6b7280;">Cancel</button>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-edit" onclick="editComment(\${cmd.id})">‚úèÔ∏è</button>
                                        <button class="btn btn-delete" onclick="deleteCommand(\${cmd.id})">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        \`;
                    }
                    
                    function editComment(taskId) {
                        document.getElementById(\`comment-display-\${taskId}\`).style.display = 'none';
                        document.getElementById(\`comment-edit-\${taskId}\`).style.display = 'block';
                        document.getElementById(\`comment-textarea-\${taskId}\`).focus();
                    }
                    
                    function cancelEdit(taskId) {
                        document.getElementById(\`comment-display-\${taskId}\`).style.display = 'block';
                        document.getElementById(\`comment-edit-\${taskId}\`).style.display = 'none';
                    }
                    
                    function saveComment(taskId) {
                        const newComment = document.getElementById(\`comment-textarea-\${taskId}\`).value;
                        
                        // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                        if (window.opener && window.opener.updateTaskComment) {
                            window.opener.updateTaskComment(taskId, newComment);
                            
                            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                            const cmd = allCommands.find(c => c.id === taskId);
                            if (cmd) {
                                cmd.comment = newComment;
                            }
                            
                            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                            const displayDiv = document.getElementById(\`comment-display-\${taskId}\`);
                            displayDiv.innerHTML = newComment 
                                ? \`<div class="comment-text">\${escapeHtml(newComment)}</div>\` 
                                : \`<div class="comment-placeholder">No comment</div>\`;
                            
                            cancelEdit(taskId);
                        } else {
                            alert('Cannot save comment. Please ensure the main QuestRoot window is still open.');
                        }
                    }
                    
                    function deleteCommand(taskId) {
                        if (confirm('Are you sure you want to delete this achievement log?')) {
                            if (window.opener && window.opener.deleteCompletedTask) {
                                window.opener.deleteCompletedTask(taskId);
                                
                                // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„Çâ„ÇÇÂâäÈô§
                                allCommands = allCommands.filter(c => c.id !== taskId);
                                
                                // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                                applyFilters();
                            } else {
                                alert('Cannot delete log. Please ensure the main QuestRoot window is still open.');
                            }
                        }
                    }
                </script>
            </body>
            </html>
        \`;
    }

    let tempWorkingSub = { text: "New Template Set", commands: [] };
    
    function renderTemplateEditor() {
        const area = document.getElementById('template-designer-area');
        area.innerHTML = `
            <div style="background: var(--panel-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--template-color); margin-bottom: 20px;">
                <h3 style="margin-top:0; color: var(--template-color);">TEMPLATE DESIGNER</h3>
                <div style="display:flex; gap:10px;"><input type="text" id="temp-name-input" style="flex:1;" placeholder="TEMPLATE NAME..."><button class="btn-utility btn-template" onclick="saveTemplate()">SAVE TEMPLATE</button></div>
                <div id="template-list-area" style="margin-top: 15px; display:flex; flex-wrap:wrap; gap:8px;"></div>
            </div>
            <div class="task-item" style="border-color: var(--sub-quest-color)">
                <span class="tier-label label-2">SUB-QUEST (ROOT)</span>
                <input type="text" value="${tempWorkingSub.text}" style="width:70%; margin-left:10px;" onchange="tempWorkingSub.text=this.value">
                <div class="sub-input-area">
                    <input type="text" id="temp-cmd-input" placeholder="COMMAND NAME..." style="flex:1;" onkeydown="if(event.ctrlKey && event.key==='Enter') addCmdToTemp()">
                    <select id="temp-cmd-type"><option value="blitz">‚ö° Blitz</option><option value="steady">üìä Steady</option></select>
                    <button class="btn-utility" onclick="addCmdToTemp()">+</button>
                </div>
                <div class="indent">${tempWorkingSub.commands.map((c, i) => `<div class="task-item"><b>${c.type==='blitz'?'‚ö°':'üìä'} ${c.text}</b></div>`).join('')}</div>
            </div>`;
        const listArea = document.getElementById('template-list-area');
        listArea.innerHTML = templates.map((t, idx) => `<div style="background:rgba(236, 72, 153, 0.2); border:1px solid var(--template-color); padding:4px 8px; border-radius:4px; font-size:0.7rem; display:flex; gap:6px; align-items:center;"><span>${t.name}</span><button onclick="deleteTemplate(${idx})" style="background:none; border:none; color:red; cursor:pointer;">&times;</button></div>`).join('');
    }

    function addCmdToTemp() {
        const txt = document.getElementById('temp-cmd-input').value;
        if(!txt) return;
        tempWorkingSub.commands.push({ text: txt, type: document.getElementById('temp-cmd-type').value, priority: 'normal' });
        document.getElementById('temp-cmd-input').value = ""; 
        renderTemplateEditor(); 
        document.getElementById('temp-cmd-input').focus();
    }

    function saveTemplate() {
        const name = document.getElementById('temp-name-input').value;
        if(!name) return;
        templates.push({ name: name, subQuest: JSON.parse(JSON.stringify(tempWorkingSub)) }); 
        saveAndRender();
    }

    function deleteTemplate(idx) { 
        templates.splice(idx, 1); 
        saveAndRender(); 
    }

    function importTemplate(sectionId, templateIdx) {
        const t = templates[templateIdx];
        const subId = Date.now();
        tasks.push({ id: subId, parentId: sectionId, text: t.subQuest.text, workDone: false, reportDone: false });
        t.subQuest.commands.forEach((c, i) => { 
            tasks.push({ id: subId+1+i, parentId: subId, text: c.text, type: c.type, priority: 'normal', workDone: false, reportDone: false }); 
        });
        saveAndRender();
    }

    // Initialize
    initDepartments();
    checkAndResetWeeklyTransfers();
    saveAndRender();
</script>
</body>
</html>
